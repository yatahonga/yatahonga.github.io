const originalUnitSize=120,displayUnitSize=60,extendHexProperties={size:{width:114.55,height:101.9},orientation:"flat",offset:1},templateCustomProperties={terrain:"off",city:"none",river:[],rail:[],germanStart:!1,control:null},Hex=Honeycomb.extendHex({...extendHexProperties,...templateCustomProperties}),Grid=Honeycomb.defineGrid(Hex),grid=Grid.rectangle({width:14,height:11,start:[0,0],direction:1}),b4mGrid=[{x:0,y:0,terrain:"open",germanReplacement:!0},{x:0,y:1,terrain:"open",rail:["NW","NE"],germanReplacement:!0},{x:0,y:2,terrain:"open",germanStart:!0,germanReplacement:!0},{x:0,y:3,terrain:"open",germanStart:!0,germanReplacement:!0},{x:0,y:4,terrain:"open",river:["S","SE"],rail:["NW","NE"],germanReplacement:!0},{x:0,y:5,terrain:"open",river:["N"],germanStart:!0,germanReplacement:!0},{x:0,y:6,terrain:"open",germanReplacement:!0},{x:0,y:7,terrain:"open",germanReplacement:!0},{x:0,y:8,terrain:"forest",germanReplacement:!0},{x:0,y:9,terrain:"open",rail:["SW","NE"],germanReplacement:!0},{x:0,y:10,terrain:"open",germanReplacement:!0},{x:1,y:1,terrain:"forest",rail:["SW","SE"],germanStart:!0},{x:1,y:2,terrain:"forest",germanStart:!0},{x:1,y:3,terrain:"forest",germanStart:!0},{x:1,y:4,terrain:"open",city:"normal",river:["S"],rail:["SW","S","SE"],germanStart:!0,control:"german"},{x:1,y:5,terrain:"open",river:["NW","N","NE"],rail:["N","SE"],germanStart:!0},{x:1,y:6,terrain:"open",germanStart:!0},{x:1,y:7,terrain:"forest"},{x:1,y:8,terrain:"forest"},{x:1,y:9,terrain:"forest",rail:["SW","SE"],germanStart:!0},{x:1,y:10,terrain:"forest",germanStart:!0},{x:2,y:0,terrain:"forest"},{x:2,y:1,terrain:"open",rail:["NW","NE"]},{x:2,y:2,terrain:"open"},{x:2,y:3,terrain:"open"},{x:2,y:4,terrain:"open",river:["SW","S","SE"],rail:["NW","NE"],germanStart:!0},{x:2,y:5,terrain:"open",river:["N"],rail:["NW","S"],germanStart:!0},{x:2,y:6,terrain:"open",city:"normal",rail:["N","SE"],germanStart:!0,control:"german"},{x:2,y:7,terrain:"forest"},{x:2,y:8,terrain:"forest",germanStart:!0},{x:2,y:9,terrain:"open",rail:["NW","NE"],germanStart:!0},{x:2,y:10,terrain:"forest"},{x:3,y:1,terrain:"forest",rail:["SW","SE"]},{x:3,y:2,terrain:"open"},{x:3,y:3,terrain:"open",river:["E"]},{x:3,y:4,terrain:"open",river:["S","SE","NE"],rail:["SW","NE"],germanStart:!0},{x:3,y:5,terrain:"forest",river:["NW","N"]},{x:3,y:6,terrain:"open",germanStart:!0},{x:3,y:7,terrain:"open",rail:["NW","SE"],germanStart:!0},{x:3,y:8,terrain:"forest",germanStart:!0},{x:3,y:9,terrain:"forest",rail:["SW","NE"],germanStart:!0},{x:3,y:10,terrain:"open",germanStart:!0},{x:4,y:0,terrain:"fortification"},{x:4,y:1,terrain:"fortification",rail:["NW","NE"]},{x:4,y:2,terrain:"fortification",river:["S","SE"]},{x:4,y:3,terrain:"fortification",river:["SW","NW","N"],rail:["SW","NE"]},{x:4,y:4,terrain:"fortification",river:["S","SW","NE"]},{x:4,y:5,terrain:"fortification",river:["N"]},{x:4,y:6,terrain:"fortification"},{x:4,y:7,terrain:"open",rail:["NW","S"]},{x:4,y:8,terrain:"open",city:"normal",rail:["N","SW","S","SE","NE"],control:"soviet"},{x:4,y:9,terrain:"forest",rail:["N","S"]},{x:4,y:10,terrain:"forest",rail:["N","S"]},{x:5,y:1,terrain:"open",city:"nornal",rail:["SW","S","SE"],control:"soviet"},{x:5,y:2,terrain:"open",rail:["N","S"]},{x:5,y:3,terrain:"open",city:"normal",river:["NE","S"],rail:["SW","N","SE"],control:"soviet"},{x:5,y:4,terrain:"forest",river:["SW","NW","N","NE","SE"]},{x:5,y:5,terrain:"open",river:["NW","NE"]},{x:5,y:6,terrain:"open"},{x:5,y:7,terrain:"open"},{x:5,y:8,terrain:"open",rail:["SW","NE"]},{x:5,y:9,terrain:"open",rail:["NW","SE"]},{x:5,y:10,terrain:"open"},{x:6,y:0,terrain:"forest"},{x:6,y:1,terrain:"forest",rail:["NW","SE"]},{x:6,y:2,terrain:"forest"},{x:6,y:3,terrain:"forest",river:["SW"],rail:["NW","NE"]},{x:6,y:4,terrain:"open",river:["NW","SW","S"]},{x:6,y:5,terrain:"open",river:["N","NW"]},{x:6,y:6,terrain:"open",rail:["S","NE"]},{x:6,y:7,terrain:"forest",rail:["SW","N"]},{x:6,y:8,terrain:"open"},{x:6,y:9,terrain:"open",rail:["NW","NE"]},{x:6,y:10,terrain:"open"},{x:7,y:1,terrain:"fortification"},{x:7,y:2,terrain:"fortification",rail:["NW","NE"]},{x:7,y:3,terrain:"fortification",city:"normal",rail:["SW","NE"],control:"soviet"},{x:7,y:4,terrain:"fortification"},{x:7,y:5,terrain:"fortification",city:"normal",river:["SW","S"],rail:["S","NE"],control:"soviet"},{x:7,y:6,terrain:"forest",river:["N","NE","SE"],rail:["N","SW"]},{x:7,y:7,terrain:"open",river:["NE","SE"]},{x:7,y:8,terrain:"open",river:["NE"]},{x:7,y:9,terrain:"open",city:"normal",rail:["SW","NE"],control:"soviet"},{x:7,y:10,terrain:"open"},{x:8,y:0,terrain:"forest",rail:["NW","SE"]},{x:8,y:1,terrain:"forest",rail:["SW","SE"]},{x:8,y:2,terrain:"open",rail:["SW","SE"]},{x:8,y:3,terrain:"open",river:["S"],rail:["S","NE"]},{x:8,y:4,terrain:"forest",river:["N","NE"],rail:["SW","N"]},{x:8,y:5,terrain:"forest",river:["SW","S","SE"]},{x:8,y:6,terrain:"open",river:["SW","NW","N"]},{x:8,y:7,terrain:"open",river:["S","SW","NW"]},{x:8,y:8,terrain:"open",river:["N","NE","SE"],rail:["SW","NE"]},{x:8,y:9,terrain:"open",river:["NE","SE"]},{x:8,y:10,terrain:"open",river:["NE"]},{x:9,y:1,terrain:"fortification",river:["NE","SE"],rail:["NW","S"]},{x:9,y:2,terrain:"fortification",river:["NE","SE"],rail:["NW","N","SE"]},{x:9,y:3,terrain:"fortification",river:["NE"],rail:["NW","SW","NE"]},{x:9,y:4,terrain:"fortification",river:["SW","S"]},{x:9,y:5,terrain:"open",river:["N","NE","SE","S"]},{x:9,y:6,terrain:"open",river:["NW","N"]},{x:9,y:7,terrain:"open"},{x:9,y:8,terrain:"open",river:["SW"],rail:["SW","NE"]},{x:9,y:9,terrain:"open",river:["NW","SW"]},{x:9,y:10,terrain:"open",river:["NW","SW"],sovietReplacement:!0},{x:10,y:0,terrain:"open",river:["SW"],sovietReplacement:!0},{x:10,y:1,terrain:"fortification",river:["SW","NW"],rail:["S","NE"]},{x:10,y:2,terrain:"open",city:"moscow",rail:["N","NE","SE","S","SW","NW"],control:"soviet"},{x:10,y:3,terrain:"fortification",river:["N","NE"],rail:["S","N"]},{x:10,y:4,terrain:"fortification",river:["SW","S","SE"],rail:["S","N"]},{x:10,y:5,terrain:"fortification",river:["NW","N"],rail:["S","N"]},{x:10,y:6,terrain:"fortification",city:"major",rail:["S","N"],control:"soviet"},{x:10,y:7,terrain:"open",rail:["N","SW"]},{x:10,y:8,terrain:"open"},{x:10,y:9,terrain:"open"},{x:10,y:10,terrain:"open",sovietReplacement:!0},{x:11,y:1,terrain:"forest",rail:["SW","SE","NE"],sovietReplacement:!0},{x:11,y:2,terrain:"open",rail:["SW","SE"]},{x:11,y:3,terrain:"fortification",river:["SW","S"],rail:["NW","S","SE"]},{x:11,y:4,terrain:"open",river:["S","SE","NE","N"],rail:["N","SE"]},{x:11,y:5,terrain:"open",river:["N","NW"]},{x:11,y:6,terrain:"open"},{x:11,y:7,terrain:"open"},{x:11,y:8,terrain:"open"},{x:11,y:9,terrain:"open"},{x:11,y:10,terrain:"open",sovietReplacement:!0},{x:12,y:0,terrain:"open",rail:["SW","NE"],sovietReplacement:!0},{x:12,y:1,terrain:"open",rail:["NW","NE"]},{x:12,y:2,terrain:"forest",rail:["NW","NE"]},{x:12,y:3,terrain:"open",river:["S","SW"],rail:["NW","NE"]},{x:12,y:4,terrain:"open",river:["NW","N","NE"],rail:["NW","SE"]},{x:12,y:5,terrain:"open"},{x:12,y:6,terrain:"open"},{x:12,y:7,terrain:"open"},{x:12,y:8,terrain:"open"},{x:12,y:9,terrain:"open"},{x:12,y:10,terrain:"open",sovietReplacement:!0},{x:13,y:1,terrain:"open",rail:["SW","SE"],sovietReplacement:!0},{x:13,y:2,terrain:"open",rail:["SW","SE"],sovietReplacement:!0},{x:13,y:3,terrain:"open",rail:["SW","SE"],sovietReplacement:!0},{x:13,y:4,terrain:"forest",river:["SW","S"],sovietReplacement:!0},{x:13,y:5,terrain:"open",city:"normal",river:["N"],rail:["NW","S"],sovietReplacement:!0,control:"soviet"},{x:13,y:6,terrain:"open",rail:["N","SE"],sovietReplacement:!0},{x:13,y:7,terrain:"open",sovietReplacement:!0},{x:13,y:8,terrain:"open",sovietReplacement:!0},{x:13,y:9,terrain:"open",sovietReplacement:!0},{x:13,y:10,terrain:"open",sovietReplacement:!0}];for(var i=0;i<b4mGrid.length;i++)grid.set([b4mGrid[i].x,b4mGrid[i].y],Hex({...templateCustomProperties,...b4mGrid[i]}));let b4mUnits=[{id:"s1sh",pos:0,army:"soviet",type:"shock",size:"XXXX",combatFull:10,combatReduced:5,movement:4,strength:"full"},{id:"s3",pos:1,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:2,y:0}},{id:"s5",pos:2,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:2,y:1}},{id:"s10",pos:3,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:2,y:2}},{id:"s13",pos:4,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:2,y:3}},{id:"s16",pos:5,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:2}},{id:"s19",pos:6,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:3,y:5}},{id:"s20",pos:7,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:5}},{id:"s24",pos:8,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:6}},{id:"s29",pos:9,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:7}},{id:"s30",pos:10,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:5,y:8}},{id:"s32",pos:11,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:8}},{id:"s33",pos:12,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:9}},{id:"s40",pos:13,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:10}},{id:"s43",pos:14,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:7,y:3}},{id:"s49",pos:15,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced"},{id:"s50",pos:16,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced"},{id:"g24",pos:0,army:"german",type:"tank",size:"XXX",combatFull:12,combatReduced:6,movement:6,strength:"full"},{id:"g41",pos:1,army:"german",type:"tank",size:"XXX",combatFull:12,combatReduced:6,movement:6,strength:"full"},{id:"g57",pos:2,army:"german",type:"tank",size:"XXX",combatFull:12,combatReduced:6,movement:6,strength:"full"},{id:"g46",pos:3,army:"german",type:"tank",size:"XXX",combatFull:10,combatReduced:5,movement:6,strength:"full"},{id:"g47",pos:4,army:"german",type:"tank",size:"XXX",combatFull:9,combatReduced:4,movement:6,strength:"full"},{id:"g56",pos:5,army:"german",type:"tank",size:"XXX",combatFull:9,combatReduced:4,movement:6,strength:"full"},{id:"g40",pos:6,army:"german",type:"tank",size:"XXX",combatFull:8,combatReduced:4,movement:6,strength:"full"},{id:"g48",pos:7,army:"german",type:"tank",size:"XXX",combatFull:8,combatReduced:4,movement:6,strength:"full"},{id:"g23",pos:8,army:"german",type:"infantry",size:"XXX",combatFull:8,combatReduced:4,movement:4,strength:"full"},{id:"g35",pos:9,army:"german",type:"infantry",size:"XXX",combatFull:8,combatReduced:4,movement:4,strength:"full"},{id:"g7",pos:10,army:"german",type:"infantry",size:"XXX",combatFull:7,combatReduced:3,movement:4,strength:"full"},{id:"g8",pos:11,army:"german",type:"infantry",size:"XXX",combatFull:7,combatReduced:3,movement:4,strength:"full"},{id:"g9",pos:12,army:"german",type:"infantry",size:"XXX",combatFull:7,combatReduced:3,movement:4,strength:"full"},{id:"g5",pos:13,army:"german",type:"infantry",size:"XXX",combatFull:6,combatReduced:3,movement:4,strength:"full"},{id:"g13",pos:14,army:"german",type:"infantry",size:"XXX",combatFull:6,combatReduced:3,movement:4,strength:"full"},{id:"g20",pos:15,army:"german",type:"infantry",size:"XXX",combatFull:6,combatReduced:3,movement:4,strength:"full"},{id:"g27",pos:16,army:"german",type:"infantry",size:"XXX",combatFull:6,combatReduced:3,movement:4,strength:"full"},{id:"g53",pos:17,army:"german",type:"infantry",size:"XXX",combatFull:6,combatReduced:3,movement:4,strength:"full"},{id:"g6",pos:18,army:"german",type:"infantry",size:"XXX",combatFull:5,combatReduced:2,movement:4,strength:"full"},{id:"g12",pos:19,army:"german",type:"infantry",size:"XXX",combatFull:5,combatReduced:2,movement:4,strength:"full"},{id:"g34",pos:20,army:"german",type:"infantry",size:"XXX",combatFull:4,combatReduced:2,movement:4,strength:"full"},{id:"g42",pos:21,army:"german",type:"infantry",size:"XXX",combatFull:4,combatReduced:2,movement:4,strength:"full"}];function b4mUnitsIndex(e){for(let t=0;t<b4mUnits.length;t++)if(e.id===b4mUnits[t].id)return t;return-1}const toNeighborsDirections=["SE","S","SW","NW","N","NE"],fromNeighborsDirections=["NW","N","NE","SE","S","SW"];let canvasBoard,board,canvasHexHighlights,hexHighlights,canvasCountersHighlights,countersHighlights,arrows,handleStep0Click,handleCombatAnnounceClick,handleMovementClick,handleReinforcementClick,handleReplacementClick,handleSpecialMovementClick;function cleanBeforeNewPhase(){hexHighlights.clearRect(0,0,canvasHexHighlights.width,canvasHexHighlights.height),countersHighlights.clearRect(0,0,canvasCountersHighlights.width,canvasCountersHighlights.height),document.getElementById("canvas_step_reinforcement").style.display="none",document.getElementById("step_0").style.display="none",document.getElementById("step_combat").style.display="none",document.getElementById("step_movement").style.display="none",document.getElementById("step_replacement").style.display="none",document.getElementById("step_special_movement").style.display="none",document.removeEventListener("click",handleStep0Click),document.removeEventListener("click",handleCombatAnnounceClick),document.removeEventListener("click",handleMovementClick),document.removeEventListener("click",handleReinforcementClick),document.removeEventListener("click",handleReplacementClick),document.removeEventListener("click",handleSpecialMovementClick)}function indexOfHex(e,t){for(let n=0;n<t.length;n++)if(e.equals(t[n]))return n;return-1}function highlightHex(e,t,n){const i=t.corners().map(e=>e.add(t.toPoint()));e.beginPath(),e.lineWidth=.1,e.moveTo(i[0].x,i[0].y);for(let t=1;t<i.length;t++)e.lineTo(i[t].x,i[t].y);e.lineTo(i[0].x,i[0].y),e.fillStyle=n||"rgba(255, 165, 0, 0.3)",e.closePath(),e.fill(),e.stroke()}function clearHex(e,t){e.globalCompositeOperation="destination-out",highlightHex(e,t,"black"),e.globalCompositeOperation="source-over"}function drawUnit(e,t,n,i){if(t.position)for(let e=0;e<b4mUnits.length;e++)if(t.id===b4mUnits[e].id){b4mUnits[e].position={x:t.position.x,y:t.position.y};let n=grid.get(t.position);n&&n.city&&"none"!==n.city&&(n.control=t.army);break}const r="soviet"===t.army?document.getElementById("soviets"):document.getElementById("germans"),a="full"===t.strength?0:120;e.drawImage(r,120*t.pos,a,120,120,n,i,60,60)}function clearUnit(e,t,n,i){for(let e=0;e<b4mUnits.length;e++)if(t.id===b4mUnits[e].id){b4mUnits[e].position=null;break}e.clearRect(n,i,80,80)}function moveUnit(e,t,n){let i={x:e.position.x,y:e.position.y},r=Hex(i).center().add(Hex(i).toPoint()),a=null;setTimeout((function(){let o=setInterval((function(){0===t.length?(n&&countersHighlights.drawImage(document.getElementById("check_counter"),r.x-40,r.y-40,80,80),clearInterval(o)):(clearUnit(board,e,r.x-40,r.y-40),a&&a.id!==e.id&&drawUnit(board,a,r.x-30,r.y-30),i=t.shift(),a=lookupUnit(Hex(i)),r=Hex(i).center().add(Hex(i).toPoint()),e.position={x:i.x,y:i.y},drawUnit(board,e,r.x-30,r.y-30))}),300)}),100)}function lookupUnit(e){if(e)for(const t of b4mUnits)if(t.position&&e.equals(t.position)){let e={id:t.id,pos:t.pos,army:t.army,type:t.type,size:t.size,combatFull:t.combatFull,combatReduced:t.combatReduced,movement:t.movement,strength:t.strength};return t.position&&(e.position={x:t.position.x,y:t.position.y}),e}return null}function isEZOC(e,t){const n="soviet"===t?"german":"soviet";for(const t of grid.neighborsOf(e))if(neighborUnit=lookupUnit(t),neighborUnit&&neighborUnit.army===n)return!0;return!1}function drawPositionedUnits(){hexHighlights.clearRect(0,0,canvasHexHighlights.width,canvasHexHighlights.height),countersHighlights.clearRect(0,0,canvasCountersHighlights.width,canvasCountersHighlights.height),board.clearRect(0,0,canvasBoard.width,canvasBoard.height);for(let e=0;e<b4mUnits.length;e++)if(b4mUnits[e].position){let t=Hex(b4mUnits[e].position),n=t.center().add(t.toPoint());drawUnit(board,b4mUnits[e],n.x-30,n.y-30)}}function drawAvailableUnits(e,t){if(t&&t.length>0){let n=70*t.length;e.width=n>300?n:300,e.height=80;let i=e.getContext("2d");for(let e=0;e<t.length;e++)for(let n=0;n<b4mUnits.length;n++)if(t[e].id===b4mUnits[n].id){drawUnit(i,b4mUnits[n],65*e+10,10);break}const r=document.getElementById("frame");i.drawImage(r,0,0,128,128,8,8,64,64)}else{e.width=300,e.height=80,e.getContext("2d").clearRect(0,0,e.width,e.height)}}function refreshBattles(){hexHighlights.clearRect(0,0,canvasHexHighlights.width,canvasHexHighlights.height),countersHighlights.clearRect(0,0,canvasCountersHighlights.width,canvasCountersHighlights.height);const e=battles.slice();if(battle){let t=grid.get(battle.defendingUnit.position),n=[];("fortification"===t.terrain&&"soviet"===battle.defendingUnit.army||"forest"===t.terrain)&&n.push(t.terrain),!t.city||"major"!==t.city&&"moscow"!==t.city||n.push("major");let i=!0;for(const e of battle.attackingUnits)if(-1===t.river.indexOf(e.attackFrom)){i=!1;break}i&&n.push("river");let r=0;for(const e of battle.attackingUnits){let t="full"===e.strength?e.combatFull:e.combatReduced;3!==currentTurn.turn&&4!==currentTurn.turn||"tank"!==e.type||(t/=2),r+=t}let a=Math.floor(r/("full"===battle.defendingUnit.strength?battle.defendingUnit.combatFull:battle.defendingUnit.combatReduced));a>6&&(a=6);let o=a-n.length;battle.attackingStrength=r,battle.modifiers=n,battle.battleOdds=o,e.push(battle)}for(const t of e){let e=grid.get(t.defendingUnit.position);highlightHex(hexHighlights,e);let n=grid.neighborsOf(e),i=e.corners();for(let r=0;r<n.length;r++){let a=lookupUnit(n[r]);if(a&&a.army!==t.defendingUnit.army&&t.attackingUnits.filter(e=>e.id===a.id).length>0){highlightHex(hexHighlights,n[r]);let t=i[r],a=r<5?i[r+1]:i[0];countersHighlights.drawImage(arrows,r*arrows.height,0,arrows.height,arrows.height,e.toPoint().x+(t.x+a.x)/2-arrows.height/4,e.toPoint().y+(t.y+a.y)/2-arrows.height/4,arrows.height/2,arrows.height/2)}}}updateDashboardCombat()}function updateDashboardCombat(){if(document.getElementById("dashboard_combat").innerHTML="",battles.length>0||battle){document.getElementById("step_combat_tip").style.display="none",document.getElementById("next_step_resolve_battles").style.display="none",document.getElementById("next_step_combat").style.display="none",document.getElementById("dashboard_combat").innerHTML='<table class="table_battle"></table>';for(let e=0;e<battles.length;e++){let t=document.createElement("tr");t.setAttribute("id","row"+(new Date).getTime()+"_"+e);const n='<td class="cell_attackers"><img src="img/'+battles[e].attackingUnits[0].army+'_marker.png" /> '+battles[e].attackingStrength+"</td>",i='<td class="cell_defender"><img src="img/'+battles[e].defendingUnit.army+'_marker.png" /> '+("full"===battles[e].defendingUnit.strength?battles[e].defendingUnit.combatFull:battles[e].defendingUnit.combatReduced)+"</td>";let r='<td class="cell_modifiers">';for(const t of battles[e].modifiers)r+='<img src="img/'+t+'_marker.png" /> ';r+="</td>",t.innerHTML=n+i+r+'<td class="cell_odds">'+battles[e].battleOdds+":1</td>";let a=document.createElement("td");a.setAttribute("class","cell_action");let o=document.createElement("i");o.setAttribute("id",(new Date).getTime()+"_"+e),o.setAttribute("class","fa fa-minus-circle"),o.setAttribute("aria-hidden","true"),o.addEventListener("click",(function(e){e.stopPropagation();const t=parseInt(RegExp("[0-9]+_([0-9]+)","g").exec(this.id)[1]);battles.splice(t,1),refreshBattles()})),a.appendChild(o),t.appendChild(a),t.addEventListener("click",(function(e){if("announce"!==currentTurn.subphase)return;e.stopPropagation();const t=parseInt(RegExp("row[0-9]+_([0-9]+)","g").exec(this.id)[1]);refreshBattles(),document.querySelector(".table_battle > tr:nth-child("+(t+1)+")").style.backgroundColor="rgba(0, 0, 255, 0.25)";for(const e of battles[t].attackingUnits)highlightHex(hexHighlights,grid.get(e.position),"rgba(0, 0, 255, 0.25)");const n=grid.get(battles[t].defendingUnit.position);highlightHex(hexHighlights,n,"rgba(0, 0, 255, 0.25)"),window.scrollTo(n.toPoint().x-window.innerWidth/2,n.toPoint().y-window.innerHeight/2)})),document.getElementById("dashboard_combat").firstChild.appendChild(t)}if(battle){let e=document.createElement("table");e.setAttribute("class","table_battle"),e.setAttribute("style","background-color: rgba(255, 255, 255, 0.2)");let t=document.createElement("tr");const n='<td class="cell_attackers"><img src="img/'+battle.attackingUnits[0].army+'_marker.png" /> '+battle.attackingStrength+"</td>",i='<td class="cell_defender"><img src="img/'+battle.defendingUnit.army+'_marker.png" /> '+("full"===battle.defendingUnit.strength?battle.defendingUnit.combatFull:battle.defendingUnit.combatReduced)+"</td>";let r='<td class="cell_modifiers">';for(const e of battle.modifiers)r+='<img src="img/'+e+'_marker.png" /> ';r+="</td>",t.innerHTML=n+i+r+'<td class="cell_odds">'+battle.battleOdds+":1</td>";let a=document.createElement("td");a.setAttribute("class","cell_action");let o=document.createElement("i");o.setAttribute("id","add_battle_button"),o.setAttribute("class","fa fa-plus-circle"),o.setAttribute("aria-hidden","true"),o.addEventListener("click",(function(e){e.stopPropagation(),battles.push(battle),battle=null,refreshBattles()})),a.appendChild(o),t.appendChild(a),e.appendChild(t),document.getElementById("dashboard_combat").appendChild(e)}else document.getElementById("next_step_resolve_battles").style.display="block",document.getElementById("next_step_resolve_battles").onclick=combatResolvePhase}else document.getElementById("step_combat").style.display="block",document.getElementById("step_combat_tip").innerText="Announce all the battles of this turn by selecting each set of defending and attacking units (or skip to the movement phase).",document.getElementById("step_combat_tip").style.display="block",document.getElementById("next_step_resolve_battles").style.display="none",document.getElementById("next_step_combat").style.display="block",document.getElementById("next_step_combat").onclick=movementPhase}let currentTurn={turn:0,army:"german",phase:"",subphase:""};function setTurnInfo(){let e="";switch(currentTurn.turn){case 1:e="October 2nd, 1941 - Turn 1/7";break;case 2:e="October 10th, 1941 - Turn 2/7";break;case 3:e="October 17th, 1941 - Turn 3/7 (Mud)";break;case 4:e="November 1st, 1941 - Turn 4/7 (Mud)";break;case 5:e="November 16th, 1941 - Turn 5/7";break;case 6:e="November 23rd, 1941 - Turn 6/7";break;case 7:e="December 1st, 1941 - Turn 7/7";break;default:console.log("ERROR - Invalid turn: ",currentTurn)}document.getElementById("turn_info").innerText=e}function turn1GermanSetupPhase(){currentTurn={turn:1,army:"german",phase:"setup",subphase:""},document.getElementById("turn_info").style.display="block",setTurnInfo(),document.getElementById("step_0").style.display="block";let e=document.getElementById("canvas_step_0"),t=b4mUnits.filter((function(e){return"german"===e.army}));drawAvailableUnits(e,t),handleStep0Click=function(n){if("counters_highlights"===n.target.id){const i=Grid.pointToHex(n.offsetX,n.offsetY);let r=grid.get(i);if(r&&r.germanStart){let n=r.center().add(r.toPoint()),i=lookupUnit(r);if(i)clearUnit(board,i,n.x-40,n.y-40),countersHighlights.clearRect(n.x-40,n.y-40,80,80),t.unshift(i),drawAvailableUnits(e,t);else{let i=t.shift();i.position={x:r.x,y:r.y},drawUnit(board,i,n.x-30,n.y-30),countersHighlights.drawImage(document.getElementById("delete_counter"),n.x-40,n.y-40,80,80),drawAvailableUnits(e,t)}}0===t.length?(document.getElementById("next_step_0").style.display="block",document.getElementById("next_step_0_button").onclick=combatAnnouncePhase):document.getElementById("next_step_0").style.display="none"}},document.addEventListener("click",handleStep0Click)}let battles=[],battle=null,battleResult="",currentBattle=null;function combatAnnouncePhase(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),currentTurn.phase="combat",currentTurn.subphase="announce",document.querySelector("#step_combat > div.menu_title > img").src="img/"+currentTurn.army+"_turn.png",document.getElementById("step_combat").style.display="block",document.getElementById("step_combat_tip").innerText="Announce all the battles of this turn by selecting each set of defending and attacking units (or skip to the movement phase).",document.getElementById("step_combat_tip").style.display="block",handleCombatAnnounceClick=function(e){const t=function(e){for(const t of battles)for(const n of t.attackingUnits)if(e.id===n.id)return!0;return!1},n="german"===currentTurn.army?"soviet":"german";if("counters_highlights"===e.target.id){const i=Grid.pointToHex(e.offsetX,e.offsetY);let r=grid.get(i);if(!r)return;let a=lookupUnit(r),o=grid.neighborsOf(r);if(a&&a.army===n&&!function(e){for(const t of battles)if(e.id===t.defendingUnit.id)return!0;return!1}(a)){if(!battle||battle.defendingUnit.id!==a.id){battle=null;let e=[];for(let i=0;i<o.length;i++){let r=lookupUnit(o[i]);r&&r.army!==n&&!t(r)&&(r.attackFrom=toNeighborsDirections[i],e.push(r))}e.length>0&&(battle={attackingUnits:e,defendingUnit:a}),refreshBattles()}}else{if(a&&a.army!==n&&battle&&!t(a))if(battle.attackingUnits.filter(e=>e.id===a.id).length>0)battle.attackingUnits=battle.attackingUnits.filter(e=>e.id!==a.id),0===battle.attackingUnits.length&&(battle=null);else{let e=!1;for(let t=0;t<o.length;t++){let n=lookupUnit(o[t]);if(n&&n.id===battle.defendingUnit.id){a.attackFrom=fromNeighborsDirections[t],e=!0;break}}e?battle.attackingUnits.push(a):battle=null}else battle=null;refreshBattles()}}},document.addEventListener("click",handleCombatAnnounceClick)}let validRetreat=[],singleValidRetreat=[],currentDefendingUnit=null,initialDefendingUnitPosition={x:-1,y:-1};function handleRetreatSelectionClick(e){const t=Grid.pointToHex(e.offsetX,e.offsetY);let n=grid.get(t);if(!n)return;let i=singleValidRetreat.filter((function(e){return e.equals(n)}));if(i.length>0){let e=i[0].from.slice();e.push({x:i[0].x,y:i[0].y}),moveUnit(currentDefendingUnit,e);for(const e of singleValidRetreat){for(const t of e.from)clearHex(hexHighlights,Hex(t)),battles.filter((function(e){return Hex(t).equals(e.defendingUnit.position)})).length>0&&highlightHex(hexHighlights,Hex(t));clearHex(hexHighlights,e)}clearHex(hexHighlights,Hex(currentDefendingUnit.position)),document.removeEventListener("click",handleRetreatSelectionClick),"EX"===battleResult?matchLoss():advanceAfterCombat()}}function findRetreat(e){const t=grid.get(currentDefendingUnit.position);let n=t.center().add(t.toPoint()),i=document.querySelector(".table_battle div.battle_result");validRetreat=[];let r="soviet"===currentDefendingUnit.army?"german":"soviet",a=grid.neighborsOf(t).filter((function(e){return e&&"off"!==e.terrain&&(!lookupUnit(e)||lookupUnit(e).army!==r)}));for(const e of a){let n=Hex(e);isEZOC(n,currentDefendingUnit.army)?n.cost=1:n.cost=0,identifyRetreat(t,n,1)}validRetreat.sort((function(e,t){return e.cost-t.cost||e.dist-t.dist}));const o="reduced"===currentDefendingUnit.strength?0:1;if(validRetreat.length>0&&validRetreat[0].cost<=o){validRetreat[0].cost>0&&(currentDefendingUnit.strength="reduced",b4mUnits[b4mUnitsIndex(currentDefendingUnit)].strength="reduced",clearUnit(board,currentDefendingUnit,n.x-40,n.y-40),drawUnit(board,currentDefendingUnit,n.x-30,n.y-30),i.innerText+=" It loses 1 step as it must retreat through an EZOC.");let r=validRetreat.filter((function(e){return validRetreat[0].cost===e.cost&&validRetreat[0].dist===e.dist}));if(singleValidRetreat=[],r.length>1){for(const e of r){let n=!1;for(const t of singleValidRetreat)if(t.x===e.x&&t.y===e.y){n=!0;break}if(!n){singleValidRetreat.push(e);let n=Hex(e).center().add(Hex(e).toPoint());hexHighlights.setLineDash([10,10]),hexHighlights.strokeStyle="rgba(0, 0, 255, 0.3)",hexHighlights.lineWidth=7,hexHighlights.beginPath();const i=t.center().add(t.toPoint());let r;hexHighlights.moveTo(i.x,i.y);for(const t of e.from)r=Hex(t).center().add(Hex(t).toPoint()),hexHighlights.lineTo(r.x,r.y);hexHighlights.lineTo(n.x,n.y),hexHighlights.stroke(),hexHighlights.beginPath(),hexHighlights.lineWidth=4,hexHighlights.setLineDash([]);const a=20,o=n.x-r.x,l=n.y-r.y,s=Math.atan2(l,o);hexHighlights.moveTo(n.x,n.y),hexHighlights.lineTo(n.x-a*Math.cos(s-Math.PI/6),n.y-a*Math.sin(s-Math.PI/6)),hexHighlights.moveTo(n.x,n.y),hexHighlights.lineTo(n.x-a*Math.cos(s+Math.PI/6),n.y-a*Math.sin(s+Math.PI/6)),hexHighlights.stroke()}}document.querySelector(".table_battle div.battle_result_action").innerText="Select a valid destination for the retreat...",document.addEventListener("click",handleRetreatSelectionClick)}else{let n=validRetreat[0].from.slice();n.push({x:validRetreat[0].x,y:validRetreat[0].y}),moveUnit(currentDefendingUnit,n),clearHex(hexHighlights,t),e()}}else i.innerText+=" But there is no valid retreat so it is eliminated.",clearUnit(board,currentDefendingUnit,n.x-40,n.y-40),clearHex(hexHighlights,t),e()}function identifyRetreat(e,t,n){const i="soviet"===lookupUnit(e).army?"german":"soviet";let r=grid.neighborsOf(t).filter((function(t){return t&&"off"!==t.terrain&&(!lookupUnit(t)||lookupUnit(t).army!==i)&&t.distance(e)>n}));for(const i of r){let r=Hex(i);r.dist=r.distance(e),r.from=[],t.from&&t.from.length>0&&(r.from=t.from.slice()),r.from.push({x:t.x,y:t.y}),r.dist===n+1&&(isEZOC(r,lookupUnit(e).army)?r.cost=t.cost+1:r.cost=t.cost,r.cost<2&&(lookupUnit(r)?identifyRetreat(e,r,n+1):validRetreat.push(r)))}}function handleAdvanceAfterCombatClick(e){const t=Grid.pointToHex(e.offsetX,e.offsetY);let n=grid.get(t);if(!n)return;let i=currentBattle.attackingUnits.filter((function(e){return Hex(e.position).equals(n)}));i.length>0&&(moveUnit(i[0],[initialDefendingUnitPosition]),document.removeEventListener("click",handleAdvanceAfterCombatClick))}function advanceAfterCombat(){document.querySelector(".table_battle div.battle_result_action").innerText="Use the option to advance into the vacated hex or continue without...",document.querySelector(".table_battle div.next_battle_button").style.display="inline-block",document.addEventListener("click",handleAdvanceAfterCombatClick)}function handleMatchLossClick(e){const t=Grid.pointToHex(e.offsetX,e.offsetY);let n=grid.get(t);if(!n)return;let i=currentBattle.attackingUnits.filter((function(e){return Hex(e.position).equals(n)}));if(i.length>0){let e=document.querySelector(".table_battle div.battle_result"),t=currentDefendingUnit.combatFull-currentDefendingUnit.combatReduced;"reduced"===currentDefendingUnit.strength&&(t=currentDefendingUnit.combatReduced);let n=Hex(i[0].position).center().add(Hex(i[0].position).toPoint());clearUnit(board,i[0],n.x-40,n.y-40),"reduced"===i[0].strength||i[0].combatFull-i[0].combatReduced<t?e.innerText+=" The selected attacking unit is eliminated during the exchange.":(i[0].strength="reduced",b4mUnits[b4mUnitsIndex(i[0])].strength="reduced",drawUnit(board,i[0],n.x-30,n.y-30),e.innerText+=" The selected attacking unit loses 1 step during the exchange."),advanceAfterCombat(),document.removeEventListener("click",handleMatchLossClick)}}function matchLoss(){let e=currentDefendingUnit.combatFull-currentDefendingUnit.combatReduced;if("reduced"===currentDefendingUnit.strength&&(e=currentDefendingUnit.combatReduced),1===currentBattle.attackingUnits.length){let t=document.querySelector(".table_battle div.battle_result"),n=Hex(currentBattle.attackingUnits[0].position).center().add(Hex(currentBattle.attackingUnits[0].position).toPoint());clearUnit(board,currentBattle.attackingUnits[0],n.x-40,n.y-40),"reduced"===currentBattle.attackingUnits[0].strength||currentBattle.attackingUnits[0].combatFull-currentBattle.attackingUnits[0].combatReduced<e?(t.innerText+=" The attacking unit is eliminated during the exchange.",document.querySelector(".table_battle div.next_battle_button").style.display="inline-block"):(currentBattle.attackingUnits[0].strength="reduced",b4mUnits[b4mUnitsIndex(currentBattle.attackingUnits[0])].strength="reduced",drawUnit(board,currentBattle.attackingUnits[0],n.x-30,n.y-30),t.innerText+=" The attacking unit loses 1 step during the exchange.",advanceAfterCombat())}else document.querySelector(".table_battle div.battle_result_action").innerText="Select the attacking unit to match the defending unit's loss (at least "+e+" strength points)...",document.addEventListener("click",handleMatchLossClick)}function handleAttackingUnitLossClick(e){const t=Grid.pointToHex(e.offsetX,e.offsetY);let n=grid.get(t);if(!n)return;let i=currentBattle.attackingUnits.filter((function(e){return Hex(e.position).equals(n)}));if(i.length>0){let e=document.querySelector(".table_battle div.battle_result"),t=Hex(i[0].position).center().add(Hex(i[0].position).toPoint());clearUnit(board,i[0],t.x-40,t.y-40),"reduced"===i[0].strength?e.innerText+=" The attacking unit strength is already reduced so it is eliminated.":(i[0].strength="reduced",b4mUnits[b4mUnitsIndex(i[0])].strength="reduced",drawUnit(board,i[0],t.x-30,t.y-30)),document.querySelector(".table_battle div.next_battle_button").style.display="inline-block",document.removeEventListener("click",handleAttackingUnitLossClick)}}function resolveNextBattle(){document.removeEventListener("click",handleAdvanceAfterCombatClick),document.removeEventListener("click",handleAttackingUnitLossClick),document.removeEventListener("click",handleMatchLossClick),document.removeEventListener("click",handleRetreatSelectionClick),refreshBattles(),document.getElementById("step_combat").style.display="block",document.getElementById("next_step_resolve_battles").style.display="none";const e=document.querySelectorAll(".table_battle > tr i");for(let t of e)t.parentNode.removeChild(t);const t=document.querySelectorAll(".table_battle > tr");if(t.length>0){currentBattle=battles.shift();const e="rgba(0, 0, 255, 0.25)";t[0].style.backgroundColor=e;for(const t of currentBattle.attackingUnits)highlightHex(hexHighlights,grid.get(t.position),e);currentDefendingUnit=currentBattle.defendingUnit,initialDefendingUnitPosition.x=currentDefendingUnit.position.x,initialDefendingUnitPosition.y=currentDefendingUnit.position.y;const n=grid.get(currentDefendingUnit.position);highlightHex(hexHighlights,n,e);let i=n.center().add(n.toPoint());window.scrollTo(n.toPoint().x-window.innerWidth/2,n.toPoint().y-window.innerHeight/2);const r=Math.floor(6*Math.random())+1;let a=document.createElement("tr");a.innerHTML='<td colspan="5" style="padding-bottom: 20px;"><img class="die_roll" src="img/'+r+'.png" /><table class="table_battle_odds"><tr><td>1:1</td><td>2:1</td><td>3:1</td><td>4:1</td><td>5:1</td><td>6:1</td></tr><tr><td>DR</td><td>DR</td><td>DR</td><td>DR</td><td>DR</td><td>DRL</td></tr><tr><td>EX</td><td>DR</td><td>DR</td><td>DR</td><td>DRL</td><td>DRL</td></tr><tr><td>EX</td><td>EX</td><td>DR</td><td>EX</td><td>DRL</td><td>DE</td></tr><tr><td>NE</td><td>EX</td><td>EX</td><td>DRL</td><td>DRL</td><td>DE</td></tr><tr><td>NE</td><td>NE</td><td>EX</td><td>DRL</td><td>DE</td><td>DE</td></tr><tr><td>AL</td><td>NE</td><td>DRL</td><td>DE</td><td>DE</td><td>DE</td></tr></table><div class="battle_result"></div><div class="battle_result_action"></div><div class="next_battle_button" style="display:none;" onclick="resolveNextBattle();">Next <i class="fa fa-arrow-circle-o-right" aria-hidden="true"></i></div></td>',t.length>1?document.querySelector(".table_battle").insertBefore(a,t[1]):document.querySelector(".table_battle").appendChild(a);let o=document.querySelectorAll(".table_battle_odds td:nth-child("+currentBattle.battleOdds+")");const l="solid thin lightgray";for(let e of o)e.style.borderLeft=l,e.style.borderRight=l;document.querySelector(".table_battle_odds tr:nth-child(1) td:nth-child("+currentBattle.battleOdds+")").style.borderTop=l,document.querySelector(".table_battle_odds tr:last-child td:nth-child("+currentBattle.battleOdds+")").style.borderBottom=l,document.querySelector(".table_battle_odds tr:nth-child("+(r+1)+")").style.border=l,document.querySelector(".table_battle_odds tr:nth-child("+(r+1)+") td:nth-child("+currentBattle.battleOdds+")").style.fontWeight="bold";let s=n.toPoint(),c=document.createElement("div");c.setAttribute("class","explosion"),c.style.display="block",c.style.top=s.y-10+"px",c.style.left=s.x-10+"px",document.body.appendChild(c),battleResult=document.querySelector(".table_battle_odds tr:nth-child("+(r+1)+") td:nth-child("+currentBattle.battleOdds+")").innerText;let d=document.querySelector(".table_battle div.battle_result");switch(battleResult){case"NE":d.innerText="The battle has no effect.",document.querySelector(".table_battle div.next_battle_button").style.display="inline-block";break;case"DR":d.innerText="The defending unit needs to retreat 2 hexes.",!n.city||"moscow"!==n.city&&"major"!==n.city||"full"!==currentDefendingUnit.strength?findRetreat(advanceAfterCombat):(currentDefendingUnit.strength="reduced",b4mUnits[b4mUnitsIndex(currentDefendingUnit)].strength="reduced",clearUnit(board,currentDefendingUnit,i.x-40,i.y-40),drawUnit(board,currentDefendingUnit,i.x-30,i.y-30),d.innerText+=" But it is in a major city, so it takes a step loss instead and doesn't retreat.",document.querySelector(".table_battle div.next_battle_button").style.display="inline-block");break;case"DRL":d.innerText="The defending unit loses 1 step and is retreated 2 hexes.","reduced"===currentDefendingUnit.strength?(d.innerText+=" But its strength is already reduced so it is eliminated.",clearUnit(board,currentDefendingUnit,i.x-40,i.y-40),clearHex(hexHighlights,n),advanceAfterCombat()):(currentDefendingUnit.strength="reduced",b4mUnits[b4mUnitsIndex(currentDefendingUnit)].strength="reduced",clearUnit(board,currentDefendingUnit,i.x-40,i.y-40),drawUnit(board,currentDefendingUnit,i.x-30,i.y-30),findRetreat(advanceAfterCombat));break;case"DE":d.innerText="The defending unit is eliminated.",clearUnit(board,currentDefendingUnit,i.x-40,i.y-40),clearHex(hexHighlights,n),advanceAfterCombat();break;case"EX":d.innerText="Exchange!","reduced"===currentDefendingUnit.strength?(d.innerText+=" The defending unit strength is already reduced so it is eliminated.",clearUnit(board,currentDefendingUnit,i.x-40,i.y-40),clearHex(hexHighlights,n),matchLoss()):(currentDefendingUnit.strength="reduced",b4mUnits[b4mUnitsIndex(currentDefendingUnit)].strength="reduced",clearUnit(board,currentDefendingUnit,i.x-40,i.y-40),drawUnit(board,currentDefendingUnit,i.x-30,i.y-30),findRetreat(matchLoss));break;case"AL":if(d.innerText="One attacking unit needs to lose 1 step.",1===currentBattle.attackingUnits.length){let e=Hex(currentBattle.attackingUnits[0].position).center().add(Hex(currentBattle.attackingUnits[0].position).toPoint());clearUnit(board,currentBattle.attackingUnits[0],e.x-40,e.y-40),"reduced"===currentBattle.attackingUnits[0].strength?d.innerText+=" The attacking unit strength is already reduced so it is eliminated.":(currentBattle.attackingUnits[0].strength="reduced",b4mUnits[b4mUnitsIndex(currentBattle.attackingUnits[0])].strength="reduced",drawUnit(board,currentBattle.attackingUnits[0],e.x-30,e.y-30)),document.querySelector(".table_battle div.next_battle_button").style.display="inline-block"}else document.querySelector(".table_battle div.battle_result_action").innerText="Select the attacking unit to be impacted...",document.addEventListener("click",handleAttackingUnitLossClick);break;default:console.log("ERROR - Invalid battle result: "+battleResult)}}else{document.getElementById("step_combat_tip").innerText="All battles have been resolved.";for(const e of document.querySelectorAll("div.explosion"))document.body.removeChild(e)}}function combatResolvePhase(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),currentTurn.phase="combat",currentTurn.subphase="resolve",battle=null,resolveNextBattle()}function getValidNormalDestinations(e,t,n){let i=Hex(e);const r="german"===t?"soviet":"german";i.credit=3===currentTurn.turn||4===currentTurn.turn?1:n,i.path=[];let a=[i],o=[i],l=[],s=0;for(;a.length>0;){let e=a.shift();s++,s>1&&l.push(e);for(const n of grid.neighborsOf(e)){let i=Hex(n);if(i&&"off"!==i.terrain){i.credit=e.credit-1,"forest"===i.terrain&&i.credit>0&&i.credit--;let n=lookupUnit(i);n&&n.army===r&&(i.credit=-1),isEZOC(i,t)&&i.credit>-1&&(i.credit=0);let l=indexOfHex(i,o);l<0?i.credit>-1&&(o.push(i),i.path=e.path.slice(),i.path.push({x:e.x,y:e.y}),a.push(i)):i.credit>o[l].credit&&(o[l].credit=i.credit,i.path=e.path.slice(),i.path.push({x:e.x,y:e.y}),a.push(i))}}}return l}let hexSelected=null,available=[],hasMoved=[];function handleMovement(e,t){const n=Grid.pointToHex(e.offsetX,e.offsetY);let i=Hex(grid.get(n)),r=lookupUnit(i);if(hexSelected){let e=null;for(let t=0;t<available.length;t++)if(i.equals(available[t])){e=Hex(available[t]);break}if(e){let t=e.path.slice(1);t.push({x:e.x,y:e.y});let n=lookupUnit(hexSelected);moveUnit(n,t,!0),hasMoved.push(n)}hexSelected=null,available=[],hexHighlights.clearRect(0,0,canvasHexHighlights.width,canvasHexHighlights.height)}else{let e=!1;for(const t of hasMoved)i&&r&&t.id===r.id&&(e=!0);if(!i||!r||r.army!==currentTurn.army||e)return hexSelected=null,available=[],void hexHighlights.clearRect(0,0,canvasHexHighlights.width,canvasHexHighlights.height);hexSelected=Hex(i);const n=r.movement;let a=t(i,currentTurn.army,n);for(let e=0;e<a.length;e++){let t=lookupUnit(grid.get(a[e]));t&&t.army===currentTurn.army||(available.push(a[e]),highlightHex(hexHighlights,a[e],"rgba(255, 255, 255, 0.35)"))}}}function movementPhase(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),currentTurn.phase="movement",currentTurn.subphase="",document.querySelector("#step_movement > div.menu_title > img").src="img/"+currentTurn.army+"_turn.png",document.getElementById("step_movement").style.display="block",7===currentTurn.turn&&"soviet"===currentTurn.army?(document.getElementById("next_step_movement").style.display="none",setTimeout((function(){document.getElementById("next_step_final").style.display="block",document.getElementById("next_step_final").onclick=finalResults}),2e3)):setTimeout((function(){4===currentTurn.turn&&"german"===currentTurn.army?document.getElementById("next_step_movement").onclick=reinforcementPhase:document.getElementById("next_step_movement").onclick=replacementPhase}),3e3),hexSelected=null,available=[],hasMoved=[],handleMovementClick=function(e){handleMovement(e,getValidNormalDestinations)},document.addEventListener("click",handleMovementClick)}let followingReinforcement=!1;function reinforcementPhase(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),currentTurn.army="soviet",currentTurn.phase="replacement",currentTurn.subphase="reinforcement",document.getElementById("step_replacement_count").innerHTML="",document.getElementById("next_step_replacement").style.display="none",document.getElementById("step_replacement").style.display="block",document.querySelector("#step_replacement > div.menu_title > img").src="img/"+currentTurn.army+"_turn.png",document.getElementById("step_replacement_tip").innerText="Place the reinforcement unit in the eligible area of the map.";let t=b4mGrid.filter((function(e){let t=grid.get({x:e.x,y:e.y}),n=!1;return!t.sovietReplacement||lookupUnit(t)||isEZOC(t,"soviet")||(highlightHex(hexHighlights,t),n=!0),n})),n=document.getElementById("canvas_step_reinforcement");n.style.display="block";let i=b4mUnits.filter((function(e){return"soviet"===e.army&&"shock"===e.type}));drawAvailableUnits(n,i),handleReinforcementClick=function(e){if("counters_highlights"===e.target.id){const r=Grid.pointToHex(e.offsetX,e.offsetY);let a=grid.get(r),o=-1;for(let e=0;e<t.length;e++)if(Hex(t[e]).equals(a)){o=e;break}if(o>-1){let e=a.center().add(a.toPoint()),t=lookupUnit(a);if(t)clearUnit(board,t,e.x-40,e.y-40),countersHighlights.clearRect(e.x-40,e.y-40,80,80),i.unshift(t),drawAvailableUnits(n,i);else{let t=i.shift();t.position={x:a.x,y:a.y},drawUnit(board,t,e.x-30,e.y-30),countersHighlights.drawImage(document.getElementById("delete_counter"),e.x-40,e.y-40,80,80),drawAvailableUnits(n,i)}}0===i.length?(followingReinforcement=!0,document.getElementById("next_step_reinforcement").style.display="block",document.getElementById("next_step_reinforcement").onclick=replacementPhase):document.getElementById("next_step_reinforcement").style.display="none"}},document.addEventListener("click",handleReinforcementClick)}function replacementPhase(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),"german"===currentTurn.army?currentTurn.army="soviet":(followingReinforcement||(currentTurn.turn++,setTurnInfo(),currentTurn.army="german"),followingReinforcement=!1),currentTurn.phase="replacement",currentTurn.subphase="standard",document.getElementById("step_replacement").style.display="block",document.getElementById("next_step_reinforcement").style.display="none",document.querySelector("#step_replacement > div.menu_title > img").src="img/"+currentTurn.army+"_turn.png",document.getElementById("step_replacement_tip").innerText="Place new half-strength units in the eligible area of the map or flip a half-strength unit that is currently on the map over to its full-strength side.",setTimeout((function(){document.getElementById("next_step_replacement").style.display="block",document.getElementById("next_step_replacement").onclick=specialMovementPhase}),2e3);let t=0;t="soviet"===currentTurn.army?3===currentTurn.turn||4===currentTurn.turn?4:5:1;const n=function(){document.getElementById("step_replacement_count").innerHTML=t>0?"You have <strong>"+t+"</strong> replacement step"+(t>1?"s":"")+" left to assign.":"You have finished assigning your replacements."};n();const i=function(e,t){let n=Hex(grid.get(e));if("soviet"===t?n.sovietReplacement:n.germanReplacement)return!0;const i="soviet"===t?10*(13-n.x):10*n.x,r="german"===t?"soviet":"german";n.credit=i,n.path=[];let a=[n],o=[n],l=0;for(;a.length>0;){let e=a.shift();l++;const n="soviet"===t?e.sovietReplacement:e.germanReplacement,i=lookupUnit(e);if(l>1&&n&&(!i||i.army===t)&&!isEZOC(e,t))return!0;for(const n of grid.neighborsOf(e)){let i=Hex(n);if(i&&"off"!==i.terrain){i.credit=e.credit-1;let n=lookupUnit(i);n&&n.army===r&&(i.credit=-1),isEZOC(i,t)&&i.credit>-1&&(i.credit=0);let l=indexOfHex(i,o);l<0?i.credit>-1&&(o.push(i),i.path=e.path.slice(),i.path.push({x:e.x,y:e.y}),a.push(i)):i.credit>o[l].credit&&(o[l].credit=i.credit,i.path=e.path.slice(),i.path.push({x:e.x,y:e.y}),a.push(i))}}}return!1},r=function(){let e=b4mUnits.filter((function(e){return e.army===currentTurn.army&&"shock"!==e.type&&!e.position})).sort((function(e,t){return"infantry"===e.type&&"tank"===t.type?1:"tank"===e.type&&"infantry"===t.type?-1:t.combatFull-e.combatFull}));return 0===e.length?null:(e[0].strength="reduced",e[0])};let a=[];r()&&(a=b4mGrid.filter((function(e){let t=grid.get({x:e.x,y:e.y}),n=!1;return!("soviet"===currentTurn.army?t.sovietReplacement:t.germanReplacement)||lookupUnit(t)||isEZOC(t,currentTurn.army)?!t.city||"none"===t.city||t.control!==currentTurn.army||lookupUnit(t)||isEZOC(t,currentTurn.army)||("soviet"===currentTurn.army&&"moscow"===t.city||i(t,currentTurn.army))&&(highlightHex(hexHighlights,t),n=!0):(highlightHex(hexHighlights,t),n=!0),n})));let o=b4mUnits.filter((function(e){return!(e.army!==currentTurn.army||"reduced"!==e.strength||!e.position||!i(Hex(e.position),currentTurn.army))&&(highlightHex(hexHighlights,Hex(e.position)),!0)}));handleReplacementClick=function(e){const i=Grid.pointToHex(e.offsetX,e.offsetY),l=Hex(grid.get(i)),s=lookupUnit(l);if(l&&t>0){let e=-1;for(let t=0;t<a.length;t++)if(Hex(a[t]).equals(l)){e=t;break}if(e>-1){let i=r();if(i){clearHex(hexHighlights,l);let r=l.center().add(l.toPoint());i.position={x:l.x,y:l.y},drawUnit(board,i,r.x-30,r.y-30),countersHighlights.drawImage(document.getElementById("check_counter"),r.x-40,r.y-40,80,80),a.splice(e,1),t--,n()}}else if(s&&s.army===currentTurn.army){let e=-1;for(let t=0;t<o.length;t++)if(Hex(o[t].position).equals(l)){e=t;break}if(e>-1){o[e].strength="full",clearHex(hexHighlights,l);let i=l.center().add(l.toPoint());drawUnit(board,o[e],i.x-30,i.y-30),countersHighlights.drawImage(document.getElementById("check_counter"),i.x-40,i.y-40,80,80),o.splice(e,1),t--,n()}}}},document.addEventListener("click",handleReplacementClick)}function getValidRailDestinations(e,t,n){let i=Hex(e),r=[];if(i.rail&&i.rail.length>0){const e="german"===t?"soviet":"german";i.credit=n,i.path=[];let a=[i],o=[i],l=0;for(;a.length>0;){let n=a.shift();l++,l>1&&r.push(n);let i=grid.neighborsOf(n),s=[];for(const e of n.rail)s.push(i[toNeighborsDirections.indexOf(e)]);for(const i of s){let r=Hex(i);if(r&&"off"!==r.terrain){r.credit=n.credit-1;let i=lookupUnit(r);i&&i.army===e&&(r.credit=-1),isEZOC(r,t)&&r.credit>-1&&(r.credit=0);let l=indexOfHex(r,o);l<0?r.credit>-1&&(o.push(r),r.path=n.path.slice(),r.path.push({x:n.x,y:n.y}),a.push(r)):r.credit>o[l].credit&&(o[l].credit=r.credit,r.path=n.path.slice(),r.path.push({x:n.x,y:n.y}),a.push(r))}}}}return r}function getValidPanzerDestinations(e,t,n){const i=lookupUnit(e);return i&&"german"===i.army&&"tank"===i.type?getValidNormalDestinations(e,t,n):[]}function specialMovementPhase(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),currentTurn.phase="special movement",currentTurn.subphase="",document.getElementById("step_special_movement").style.display="block",document.querySelector("#step_special_movement > div.menu_title > img").src="img/"+currentTurn.army+"_turn.png",document.getElementById("step_special_movement_tip").innerText="soviet"===currentTurn.army?"All units that begin this phase on a rail line may move along it.":"All armor/panzer units may move.",setTimeout((function(){document.getElementById("next_step_special_movement").style.display="block",document.getElementById("next_step_special_movement").onclick=combatAnnouncePhase}),2e3),hexSelected=null,available=[],hasMoved=[],handleSpecialMovementClick=function(e){"soviet"===currentTurn.army?handleMovement(e,getValidRailDestinations):handleMovement(e,getValidPanzerDestinations)},document.addEventListener("click",handleSpecialMovementClick)}function finalResults(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),currentTurn.phase="game over",currentTurn.subphase="",document.getElementById("final_results").style.display="block",console.log("GAME OVER");let t="",n="",i="";for(const e of b4mGrid)if(e.city&&"moscow"===e.city){i=grid.get(e).control;break}if("german"===i)t='<img src="img/german_marker.png" /><span>The German Army won!</span>',n="The German Army wins because it controls Moscow at the end of Game Turn 7.";else{b4mGrid.filter((function(e){const t=grid.get(e);return t.city&&"moscow"!==t.city&&"soviet"===t.control})).length>0?(t='<img src="img/soviet_marker.png" /><span>The Red Army won!</span>',n="The Red Army wins because it controls Moscow and one other city at the end of Game Turn 7."):(t="<span>It is a draw!</span>",n="The Red Army still controls Moscow but the German Army controls all the other cities at the end of Game Turn 7.")}document.querySelector("#final_results > div.menu_title").innerHTML=t,document.getElementById("final_results_tip").innerText=n}function start(){document.getElementById("next_start").removeEventListener("click",start),document.documentElement.requestFullscreen(),screen.orientation.lock("landscape-primary").then(null,(function(e){console.log(e)})),document.body.style.overflow="visible";let e=document.getElementById("splash_title");document.body.removeChild(e);let t=document.getElementById("splash_background");document.body.removeChild(t),canvasBoard=document.getElementById("board"),canvasBoard.width=document.getElementById("map").width,canvasBoard.height=document.getElementById("map").height,board=canvasBoard.getContext("2d"),canvasHexHighlights=document.getElementById("hex_highlights"),canvasHexHighlights.width=document.getElementById("map").width,canvasHexHighlights.height=document.getElementById("map").height,hexHighlights=canvasHexHighlights.getContext("2d"),canvasCountersHighlights=document.getElementById("counters_highlights"),canvasCountersHighlights.width=document.getElementById("map").width,canvasCountersHighlights.height=document.getElementById("map").height,countersHighlights=canvasCountersHighlights.getContext("2d"),arrows=document.getElementById("arrows_counter"),drawPositionedUnits(),turn1GermanSetupPhase(board,hexHighlights,countersHighlights)}window.addEventListener("load",(function(){screen.orientation.type.indexOf("portrait")>-1&&(document.getElementById("rotate").style.display="block"),screen.orientation.addEventListener("change",(function(){screen.orientation.type.indexOf("landscape")>-1?document.getElementById("rotate").style.display="none":document.getElementById("rotate").style.display="block",console.log("New orientation is ",screen.orientation.type)})),document.getElementById("next_start").addEventListener("click",start,!0)}));
