const originalUnitSize=120,displayUnitSize=60,extendHexProperties={size:{width:114.55,height:101.9},orientation:"flat",offset:1},templateCustomProperties={terrain:"off",city:"none",river:[],rail:[],germanStart:!1,control:null},Hex=Honeycomb.extendHex({...extendHexProperties,...templateCustomProperties}),Grid=Honeycomb.defineGrid(Hex),grid=Grid.rectangle({width:14,height:11,start:[0,0],direction:1}),b4mGrid=[{x:0,y:0,terrain:"open",germanReplacement:!0},{x:0,y:1,terrain:"open",rail:["NW","NE"],germanReplacement:!0},{x:0,y:2,terrain:"open",germanStart:!0,germanReplacement:!0},{x:0,y:3,terrain:"open",germanStart:!0,germanReplacement:!0},{x:0,y:4,terrain:"open",river:["S","SE"],rail:["NW","NE"],germanReplacement:!0},{x:0,y:5,terrain:"open",river:["N"],germanStart:!0,germanReplacement:!0},{x:0,y:6,terrain:"open",germanReplacement:!0},{x:0,y:7,terrain:"open",germanReplacement:!0},{x:0,y:8,terrain:"forest",germanReplacement:!0},{x:0,y:9,terrain:"open",rail:["SW","NE"],germanReplacement:!0},{x:0,y:10,terrain:"open",germanReplacement:!0},{x:1,y:1,terrain:"forest",rail:["SW","SE"],germanStart:!0},{x:1,y:2,terrain:"forest",germanStart:!0},{x:1,y:3,terrain:"forest",germanStart:!0},{x:1,y:4,terrain:"open",city:"normal",river:["S"],rail:["SW","S","SE"],germanStart:!0,control:"german"},{x:1,y:5,terrain:"open",river:["NW","N","NE"],rail:["N","SE"],germanStart:!0},{x:1,y:6,terrain:"open",germanStart:!0},{x:1,y:7,terrain:"forest"},{x:1,y:8,terrain:"forest"},{x:1,y:9,terrain:"forest",rail:["SW","SE"],germanStart:!0},{x:1,y:10,terrain:"forest",germanStart:!0},{x:2,y:0,terrain:"forest"},{x:2,y:1,terrain:"open",rail:["NW","NE"]},{x:2,y:2,terrain:"open"},{x:2,y:3,terrain:"open"},{x:2,y:4,terrain:"open",river:["SW","S","SE"],rail:["NW","NE"],germanStart:!0},{x:2,y:5,terrain:"open",river:["N"],rail:["NW","S"],germanStart:!0},{x:2,y:6,terrain:"open",city:"normal",rail:["N","SE"],germanStart:!0,control:"german"},{x:2,y:7,terrain:"forest"},{x:2,y:8,terrain:"forest",germanStart:!0},{x:2,y:9,terrain:"open",rail:["NW","NE"],germanStart:!0},{x:2,y:10,terrain:"forest"},{x:3,y:1,terrain:"forest",rail:["SW","SE"]},{x:3,y:2,terrain:"open"},{x:3,y:3,terrain:"open",river:["E"]},{x:3,y:4,terrain:"open",river:["S","SE","NE"],rail:["SW","NE"],germanStart:!0},{x:3,y:5,terrain:"forest",river:["NW","N"]},{x:3,y:6,terrain:"open",germanStart:!0},{x:3,y:7,terrain:"open",rail:["NW","SE"],germanStart:!0},{x:3,y:8,terrain:"forest",germanStart:!0},{x:3,y:9,terrain:"forest",rail:["SW","NE"],germanStart:!0},{x:3,y:10,terrain:"open",germanStart:!0},{x:4,y:0,terrain:"fortification"},{x:4,y:1,terrain:"fortification",rail:["NW","NE"]},{x:4,y:2,terrain:"fortification",river:["S","SE"]},{x:4,y:3,terrain:"fortification",river:["SW","NW","N"],rail:["SW","NE"]},{x:4,y:4,terrain:"fortification",river:["S","SW","NE"]},{x:4,y:5,terrain:"fortification",river:["N"]},{x:4,y:6,terrain:"fortification"},{x:4,y:7,terrain:"open",rail:["NW","S"]},{x:4,y:8,terrain:"open",city:"normal",rail:["N","SW","S","SE","NE"],control:"soviet"},{x:4,y:9,terrain:"forest",rail:["N","S"]},{x:4,y:10,terrain:"forest",rail:["N","S"]},{x:5,y:1,terrain:"open",city:"nornal",rail:["SW","S","SE"],control:"soviet"},{x:5,y:2,terrain:"open",rail:["N","S"]},{x:5,y:3,terrain:"open",city:"normal",river:["NE","S"],rail:["SW","N","SE"],control:"soviet"},{x:5,y:4,terrain:"forest",river:["SW","NW","N","NE","SE"]},{x:5,y:5,terrain:"open",river:["NW","NE"]},{x:5,y:6,terrain:"open"},{x:5,y:7,terrain:"open"},{x:5,y:8,terrain:"open",rail:["SW","NE"]},{x:5,y:9,terrain:"open",rail:["NW","SE"]},{x:5,y:10,terrain:"open"},{x:6,y:0,terrain:"forest"},{x:6,y:1,terrain:"forest",rail:["NW","SE"]},{x:6,y:2,terrain:"forest"},{x:6,y:3,terrain:"forest",river:["SW"],rail:["NW","NE"]},{x:6,y:4,terrain:"open",river:["NW","SW","S"]},{x:6,y:5,terrain:"open",river:["N","NW"]},{x:6,y:6,terrain:"open",rail:["S","NE"]},{x:6,y:7,terrain:"forest",rail:["SW","N"]},{x:6,y:8,terrain:"open"},{x:6,y:9,terrain:"open",rail:["NW","NE"]},{x:6,y:10,terrain:"open"},{x:7,y:1,terrain:"fortification"},{x:7,y:2,terrain:"fortification",rail:["NW","NE"]},{x:7,y:3,terrain:"fortification",city:"normal",rail:["SW","NE"],control:"soviet"},{x:7,y:4,terrain:"fortification"},{x:7,y:5,terrain:"fortification",city:"normal",river:["SW","S"],rail:["S","NE"],control:"soviet"},{x:7,y:6,terrain:"forest",river:["N","NE","SE"],rail:["N","SW"]},{x:7,y:7,terrain:"open",river:["NE","SE"]},{x:7,y:8,terrain:"open",river:["NE"]},{x:7,y:9,terrain:"open",city:"normal",rail:["SW","NE"],control:"soviet"},{x:7,y:10,terrain:"open"},{x:8,y:0,terrain:"forest",rail:["NW","SE"]},{x:8,y:1,terrain:"forest",rail:["SW","SE"]},{x:8,y:2,terrain:"open",rail:["SW","SE"]},{x:8,y:3,terrain:"open",river:["S"],rail:["S","NE"]},{x:8,y:4,terrain:"forest",river:["N","NE"],rail:["SW","N"]},{x:8,y:5,terrain:"forest",river:["SW","S","SE"]},{x:8,y:6,terrain:"open",river:["SW","NW","N"]},{x:8,y:7,terrain:"open",river:["S","SW","NW"]},{x:8,y:8,terrain:"open",river:["N","NE","SE"],rail:["SW","NE"]},{x:8,y:9,terrain:"open",river:["NE","SE"]},{x:8,y:10,terrain:"open",river:["NE"]},{x:9,y:1,terrain:"fortification",river:["NE","SE"],rail:["NW","S"]},{x:9,y:2,terrain:"fortification",river:["NE","SE"],rail:["NW","N","SE"]},{x:9,y:3,terrain:"fortification",river:["NE"],rail:["NW","SW","NE"]},{x:9,y:4,terrain:"fortification",river:["SW","S"]},{x:9,y:5,terrain:"open",river:["N","NE","SE","S"]},{x:9,y:6,terrain:"open",river:["NW","N"]},{x:9,y:7,terrain:"open"},{x:9,y:8,terrain:"open",river:["SW"],rail:["SW","NE"]},{x:9,y:9,terrain:"open",river:["NW","SW"]},{x:9,y:10,terrain:"open",river:["NW","SW"],sovietReplacement:!0},{x:10,y:0,terrain:"open",river:["SW"],sovietReplacement:!0},{x:10,y:1,terrain:"fortification",river:["SW","NW"],rail:["S","NE"]},{x:10,y:2,terrain:"open",city:"moscow",rail:["N","NE","SE","S","SW","NW"],control:"soviet"},{x:10,y:3,terrain:"fortification",river:["N","NE"],rail:["S","N"]},{x:10,y:4,terrain:"fortification",river:["SW","S","SE"],rail:["S","N"]},{x:10,y:5,terrain:"fortification",river:["NW","N"],rail:["S","N"]},{x:10,y:6,terrain:"fortification",city:"major",rail:["S","N"],control:"soviet"},{x:10,y:7,terrain:"open",rail:["N","SW"]},{x:10,y:8,terrain:"open"},{x:10,y:9,terrain:"open"},{x:10,y:10,terrain:"open",sovietReplacement:!0},{x:11,y:1,terrain:"forest",rail:["SW","SE","NE"],sovietReplacement:!0},{x:11,y:2,terrain:"open",rail:["SW","SE"]},{x:11,y:3,terrain:"fortification",river:["SW","S"],rail:["NW","S","SE"]},{x:11,y:4,terrain:"open",river:["S","SE","NE","N"],rail:["N","SE"]},{x:11,y:5,terrain:"open",river:["N","NW"]},{x:11,y:6,terrain:"open"},{x:11,y:7,terrain:"open"},{x:11,y:8,terrain:"open"},{x:11,y:9,terrain:"open"},{x:11,y:10,terrain:"open",sovietReplacement:!0},{x:12,y:0,terrain:"open",rail:["SW","NE"],sovietReplacement:!0},{x:12,y:1,terrain:"open",rail:["NW","NE"]},{x:12,y:2,terrain:"forest",rail:["NW","NE"]},{x:12,y:3,terrain:"open",river:["S","SW"],rail:["NW","NE"]},{x:12,y:4,terrain:"open",river:["NW","N","NE"],rail:["NW","SE"]},{x:12,y:5,terrain:"open"},{x:12,y:6,terrain:"open"},{x:12,y:7,terrain:"open"},{x:12,y:8,terrain:"open"},{x:12,y:9,terrain:"open"},{x:12,y:10,terrain:"open",sovietReplacement:!0},{x:13,y:1,terrain:"open",rail:["SW","SE"],sovietReplacement:!0},{x:13,y:2,terrain:"open",rail:["SW","SE"],sovietReplacement:!0},{x:13,y:3,terrain:"open",rail:["SW","SE"],sovietReplacement:!0},{x:13,y:4,terrain:"forest",river:["SW","S"],sovietReplacement:!0},{x:13,y:5,terrain:"open",city:"normal",river:["N"],rail:["NW","S"],sovietReplacement:!0,control:"soviet"},{x:13,y:6,terrain:"open",rail:["N","SE"],sovietReplacement:!0},{x:13,y:7,terrain:"open",sovietReplacement:!0},{x:13,y:8,terrain:"open",sovietReplacement:!0},{x:13,y:9,terrain:"open",sovietReplacement:!0},{x:13,y:10,terrain:"open",sovietReplacement:!0}];for(var i=0;i<b4mGrid.length;i++)grid.set([b4mGrid[i].x,b4mGrid[i].y],Hex({...templateCustomProperties,...b4mGrid[i]}));let b4mUnits=[{id:"s1sh",pos:0,army:"soviet",type:"shock",size:"XXXX",combatFull:10,combatReduced:5,movement:4,strength:"full"},{id:"s3",pos:1,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:2,y:0}},{id:"s5",pos:2,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:2,y:1}},{id:"s10",pos:3,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:2,y:2}},{id:"s13",pos:4,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:2,y:3}},{id:"s16",pos:5,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:2}},{id:"s19",pos:6,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:3,y:5}},{id:"s20",pos:7,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:5}},{id:"s24",pos:8,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:6}},{id:"s29",pos:9,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:7}},{id:"s30",pos:10,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:5,y:8}},{id:"s32",pos:11,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:8}},{id:"s33",pos:12,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:9}},{id:"s40",pos:13,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:4,y:10}},{id:"s43",pos:14,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced",position:{x:7,y:3}},{id:"s49",pos:15,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced"},{id:"s50",pos:16,army:"soviet",type:"infantry",size:"XXXX",combatFull:8,combatReduced:4,movement:4,strength:"reduced"},{id:"g24",pos:0,army:"german",type:"tank",size:"XXX",combatFull:12,combatReduced:6,movement:6,strength:"full"},{id:"g41",pos:1,army:"german",type:"tank",size:"XXX",combatFull:12,combatReduced:6,movement:6,strength:"full"},{id:"g57",pos:2,army:"german",type:"tank",size:"XXX",combatFull:12,combatReduced:6,movement:6,strength:"full"},{id:"g46",pos:3,army:"german",type:"tank",size:"XXX",combatFull:10,combatReduced:5,movement:6,strength:"full"},{id:"g47",pos:4,army:"german",type:"tank",size:"XXX",combatFull:9,combatReduced:4,movement:6,strength:"full"},{id:"g56",pos:5,army:"german",type:"tank",size:"XXX",combatFull:9,combatReduced:4,movement:6,strength:"full"},{id:"g40",pos:6,army:"german",type:"tank",size:"XXX",combatFull:8,combatReduced:4,movement:6,strength:"full"},{id:"g48",pos:7,army:"german",type:"tank",size:"XXX",combatFull:8,combatReduced:4,movement:6,strength:"full"},{id:"g23",pos:8,army:"german",type:"infantry",size:"XXX",combatFull:8,combatReduced:4,movement:4,strength:"full"},{id:"g35",pos:9,army:"german",type:"infantry",size:"XXX",combatFull:8,combatReduced:4,movement:4,strength:"full"},{id:"g7",pos:10,army:"german",type:"infantry",size:"XXX",combatFull:7,combatReduced:3,movement:4,strength:"full"},{id:"g8",pos:11,army:"german",type:"infantry",size:"XXX",combatFull:7,combatReduced:3,movement:4,strength:"full"},{id:"g9",pos:12,army:"german",type:"infantry",size:"XXX",combatFull:7,combatReduced:3,movement:4,strength:"full"},{id:"g5",pos:13,army:"german",type:"infantry",size:"XXX",combatFull:6,combatReduced:3,movement:4,strength:"full"},{id:"g13",pos:14,army:"german",type:"infantry",size:"XXX",combatFull:6,combatReduced:3,movement:4,strength:"full"},{id:"g20",pos:15,army:"german",type:"infantry",size:"XXX",combatFull:6,combatReduced:3,movement:4,strength:"full"},{id:"g27",pos:16,army:"german",type:"infantry",size:"XXX",combatFull:6,combatReduced:3,movement:4,strength:"full"},{id:"g53",pos:17,army:"german",type:"infantry",size:"XXX",combatFull:6,combatReduced:3,movement:4,strength:"full"},{id:"g6",pos:18,army:"german",type:"infantry",size:"XXX",combatFull:5,combatReduced:2,movement:4,strength:"full"},{id:"g12",pos:19,army:"german",type:"infantry",size:"XXX",combatFull:5,combatReduced:2,movement:4,strength:"full"},{id:"g34",pos:20,army:"german",type:"infantry",size:"XXX",combatFull:4,combatReduced:2,movement:4,strength:"full"},{id:"g42",pos:21,army:"german",type:"infantry",size:"XXX",combatFull:4,combatReduced:2,movement:4,strength:"full"}];function b4mUnitsIndex(e){for(let t=0;t<b4mUnits.length;t++)if(e.id===b4mUnits[t].id)return t;return-1}const toNeighborsDirections=["SE","S","SW","NW","N","NE"],fromNeighborsDirections=["NW","N","NE","SE","S","SW"];let canvasBoard,board,canvasHexHighlights,hexHighlights,canvasCountersHighlights,countersHighlights,arrows,handleStep0Click,handleCombatAnnounceClick,handleMovementClick,handleReinforcementClick,handleReplacementClick,handleSpecialMovementClick;function cleanBeforeNewPhase(){hexHighlights.clearRect(0,0,canvasHexHighlights.width,canvasHexHighlights.height),countersHighlights.clearRect(0,0,canvasCountersHighlights.width,canvasCountersHighlights.height),document.getElementById("canvas_step_reinforcement").style.display="none",document.getElementById("step_0").style.display="none",document.getElementById("step_combat").style.display="none",document.getElementById("step_movement").style.display="none",document.getElementById("step_replacement").style.display="none",document.getElementById("step_special_movement").style.display="none",document.removeEventListener("click",handleStep0Click),document.removeEventListener("click",handleCombatAnnounceClick),document.removeEventListener("click",handleMovementClick),document.removeEventListener("click",handleReinforcementClick),document.removeEventListener("click",handleReplacementClick),document.removeEventListener("click",handleSpecialMovementClick)}function highlightHex(e,t,n){const r=t.corners().map(e=>e.add(t.toPoint()));e.beginPath(),e.lineWidth=.1,e.moveTo(r[0].x,r[0].y);for(let a=1;a<r.length;a++)e.lineTo(r[a].x,r[a].y);e.lineTo(r[0].x,r[0].y),e.fillStyle=n?n:"rgba(255, 165, 0, 0.3)",e.closePath(),e.fill(),e.stroke()}function clearHex(e,t){e.globalCompositeOperation="destination-out",highlightHex(e,t,"black"),e.globalCompositeOperation="source-over"}function drawUnit(e,t,n,i){if(t.position)for(let e=0;e<b4mUnits.length;e++)if(t.id===b4mUnits[e].id){b4mUnits[e].position={x:t.position.x,y:t.position.y};let n=grid.get(t.position);n&&n.city&&"none"!==n.city&&(n.control=t.army);break}const r="soviet"===t.army?document.getElementById("soviets"):document.getElementById("germans"),a="full"===t.strength?0:originalUnitSize;e.drawImage(r,t.pos*originalUnitSize,a,originalUnitSize,originalUnitSize,n,i,displayUnitSize,displayUnitSize)}function clearUnit(e,t,n,i){for(let r=0;r<b4mUnits.length;r++)if(t.id===b4mUnits[r].id){b4mUnits[r].position=null;break}e.clearRect(n,i,displayUnitSize+20,displayUnitSize+20)}function moveUnit(e,t,n){let i={x:e.position.x,y:e.position.y},r=Hex(i).center().add(Hex(i).toPoint()),a=null;setTimeout(function(){let o=setInterval(function(){0===t.length?(n&&countersHighlights.drawImage(document.getElementById("check_counter"),r.x-(displayUnitSize/2+10),r.y-(displayUnitSize/2+10),displayUnitSize+20,displayUnitSize+20),clearInterval(o)):(clearUnit(board,e,r.x-(displayUnitSize/2+10),r.y-(displayUnitSize/2+10)),a&&a.id!==e.id&&drawUnit(board,a,r.x-displayUnitSize/2,r.y-displayUnitSize/2),i=t.shift(),a=lookupUnit(Hex(i)),r=Hex(i).center().add(Hex(i).toPoint()),e.position={x:i.x,y:i.y},drawUnit(board,e,r.x-displayUnitSize/2,r.y-displayUnitSize/2))},300)},100)}function lookupUnit(e){if(e)for(const t of b4mUnits)if(t.position&&e.equals(t.position)){let e={id:t.id,pos:t.pos,army:t.army,type:t.type,size:t.size,combatFull:t.combatFull,combatReduced:t.combatReduced,movement:t.movement,strength:t.strength};return t.position&&(e.position={x:t.position.x,y:t.position.y}),e}return null}function isEZOC(e,t){const n="soviet"===t?"german":"soviet";for(const i of grid.neighborsOf(e))if(neighborUnit=lookupUnit(i),neighborUnit&&neighborUnit.army===n)return!0;return!1}function drawPositionedUnits(){hexHighlights.clearRect(0,0,canvasHexHighlights.width,canvasHexHighlights.height),countersHighlights.clearRect(0,0,canvasCountersHighlights.width,canvasCountersHighlights.height),board.clearRect(0,0,canvasBoard.width,canvasBoard.height);for(let e=0;e<b4mUnits.length;e++)if(b4mUnits[e].position){let t=Hex(b4mUnits[e].position),n=t.center().add(t.toPoint());drawUnit(board,b4mUnits[e],n.x-displayUnitSize/2,n.y-displayUnitSize/2)}}function drawAvailableUnits(e,t){if(t&&0<t.length){let n=(displayUnitSize+10)*t.length;e.width=300<n?n:300,e.height=displayUnitSize+20;let r=e.getContext("2d");for(let e=0;e<t.length;e++)for(let n=0;n<b4mUnits.length;n++)if(t[e].id===b4mUnits[n].id){drawUnit(r,b4mUnits[n],e*(displayUnitSize+5)+10,10);break}const a=document.getElementById("frame");r.drawImage(a,0,0,128,128,8,8,displayUnitSize+4,displayUnitSize+4)}else{e.width=300,e.height=displayUnitSize+20;let t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)}}function refreshBattles(){hexHighlights.clearRect(0,0,canvasHexHighlights.width,canvasHexHighlights.height),countersHighlights.clearRect(0,0,canvasCountersHighlights.width,canvasCountersHighlights.height);const e=battles.slice();if(battle){let t=grid.get(battle.defendingUnit.position),n=[];("fortification"===t.terrain&&"soviet"===battle.defendingUnit.army||"forest"===t.terrain)&&n.push(t.terrain),t.city&&("major"===t.city||"moscow"===t.city)&&n.push("major");let i=!0;for(const e of battle.attackingUnits)if(-1===t.river.indexOf(e.attackFrom)){i=!1;break}i&&n.push("river");let r=0;for(const e of battle.attackingUnits){let t="full"===e.strength?e.combatFull:e.combatReduced;(3===currentTurn.turn||4===currentTurn.turn)&&"tank"===e.type&&(t/=2),r+=t}let a=Math.floor(r/("full"===battle.defendingUnit.strength?battle.defendingUnit.combatFull:battle.defendingUnit.combatReduced));6<a&&(a=6);let o=a-n.length;battle.attackingStrength=r,battle.modifiers=n,battle.battleOdds=o,e.push(battle)}for(const t of e){let e=grid.get(t.defendingUnit.position);highlightHex(hexHighlights,e);let n=grid.neighborsOf(e),r=e.corners();for(let o,a=0;a<n.length;a++)if(o=lookupUnit(n[a]),o&&o.army!==t.defendingUnit.army&&0<t.attackingUnits.filter(e=>e.id===o.id).length){highlightHex(hexHighlights,n[a]);let t=r[a],i=5>a?r[a+1]:r[0];countersHighlights.drawImage(arrows,a*arrows.height,0,arrows.height,arrows.height,e.toPoint().x+(t.x+i.x)/2-arrows.height/4,e.toPoint().y+(t.y+i.y)/2-arrows.height/4,arrows.height/2,arrows.height/2)}}updateDashboardCombat()}function updateDashboardCombat(){if(document.getElementById("dashboard_combat").innerHTML="",0<battles.length||battle){document.getElementById("step_combat_tip").style.display="none",document.getElementById("next_step_resolve_battles").style.display="none",document.getElementById("next_step_combat").style.display="none",document.getElementById("dashboard_combat").innerHTML="<table class=\"table_battle\"></table>";for(let e,t=0;t<battles.length;t++){e=document.createElement("tr"),e.setAttribute("id","row"+new Date().getTime()+"_"+t);const n="<td class=\"cell_attackers\"><img src=\"img/"+battles[t].attackingUnits[0].army+"_marker.png\" /> "+battles[t].attackingStrength+"</td>",i="<td class=\"cell_defender\"><img src=\"img/"+battles[t].defendingUnit.army+"_marker.png\" /> "+("full"===battles[t].defendingUnit.strength?battles[t].defendingUnit.combatFull:battles[t].defendingUnit.combatReduced)+"</td>";let r="<td class=\"cell_modifiers\">";for(const e of battles[t].modifiers)r+="<img src=\"img/"+e+"_marker.png\" /> ";r+="</td>",e.innerHTML=n+i+r+"<td class=\"cell_odds\">"+battles[t].battleOdds+":1</td>";let a=document.createElement("td");a.setAttribute("class","cell_action");let o=document.createElement("i");o.setAttribute("id",new Date().getTime()+"_"+t),o.setAttribute("class","fa fa-minus-circle"),o.setAttribute("aria-hidden","true"),o.addEventListener("click",function(e){e.stopPropagation();const t=parseInt(/[0-9]+_([0-9]+)/g.exec(this.id)[1]);battles.splice(t,1),refreshBattles()}),a.appendChild(o),e.appendChild(a),e.addEventListener("click",function(e){if("announce"!==currentTurn.subphase)return;e.stopPropagation();const t=parseInt(/row[0-9]+_([0-9]+)/g.exec(this.id)[1]);refreshBattles(),document.querySelector(".table_battle > tr:nth-child("+(t+1)+")").style.backgroundColor="rgba(0, 0, 255, 0.25)";for(const n of battles[t].attackingUnits)highlightHex(hexHighlights,grid.get(n.position),"rgba(0, 0, 255, 0.25)");const n=grid.get(battles[t].defendingUnit.position);highlightHex(hexHighlights,n,"rgba(0, 0, 255, 0.25)"),window.scrollTo(n.toPoint().x-window.innerWidth/2,n.toPoint().y-window.innerHeight/2)}),document.getElementById("dashboard_combat").firstChild.appendChild(e)}if(battle){let e=document.createElement("table");e.setAttribute("class","table_battle"),e.setAttribute("style","background-color: rgba(255, 255, 255, 0.2)");let t=document.createElement("tr");const n="<td class=\"cell_attackers\"><img src=\"img/"+battle.attackingUnits[0].army+"_marker.png\" /> "+battle.attackingStrength+"</td>",i="<td class=\"cell_defender\"><img src=\"img/"+battle.defendingUnit.army+"_marker.png\" /> "+("full"===battle.defendingUnit.strength?battle.defendingUnit.combatFull:battle.defendingUnit.combatReduced)+"</td>";let r="<td class=\"cell_modifiers\">";for(const e of battle.modifiers)r+="<img src=\"img/"+e+"_marker.png\" /> ";r+="</td>",t.innerHTML=n+i+r+"<td class=\"cell_odds\">"+battle.battleOdds+":1</td>";let a=document.createElement("td");a.setAttribute("class","cell_action");let o=document.createElement("i");o.setAttribute("id","add_battle_button"),o.setAttribute("class","fa fa-plus-circle"),o.setAttribute("aria-hidden","true"),o.addEventListener("click",function(e){e.stopPropagation(),battles.push(battle),battle=null,refreshBattles()}),a.appendChild(o),t.appendChild(a),e.appendChild(t),document.getElementById("dashboard_combat").appendChild(e)}else document.getElementById("next_step_resolve_battles").style.display="block",document.getElementById("next_step_resolve_battles").onclick=combatResolvePhase}else document.getElementById("step_combat").style.display="block",document.getElementById("step_combat_tip").innerText="Announce all the battles of this turn by selecting each set of defending and attacking units (or skip to the movement phase).",document.getElementById("step_combat_tip").style.display="block",document.getElementById("next_step_resolve_battles").style.display="none",document.getElementById("next_step_combat").style.display="block",document.getElementById("next_step_combat").onclick=movementPhase}let currentTurn={turn:0,army:"german",phase:"",subphase:""};function setTurnInfo(){let e="";switch(currentTurn.turn){case 1:e="October 2nd, 1941 - Turn 1/7";break;case 2:e="October 10th, 1941 - Turn 2/7";break;case 3:e="October 17th, 1941 - Turn 3/7 (Mud)";break;case 4:e="November 1st, 1941 - Turn 4/7 (Mud)";break;case 5:e="November 16th, 1941 - Turn 5/7";break;case 6:e="November 23rd, 1941 - Turn 6/7";break;case 7:e="December 1st, 1941 - Turn 7/7";break;default:console.log("ERROR - Invalid turn: ",currentTurn);}document.getElementById("turn_info").innerText=e}function turn1GermanSetupPhase(){currentTurn={turn:1,army:"german",phase:"setup",subphase:""},document.getElementById("turn_info").style.display="block",setTurnInfo(),document.getElementById("step_0").style.display="block";let e=document.getElementById("canvas_step_0"),t=b4mUnits.filter(function(e){return"german"===e.army});drawAvailableUnits(e,t),handleStep0Click=function(n){if("counters_highlights"===n.target.id){const i=Grid.pointToHex(n.offsetX,n.offsetY);let r=grid.get(i);if(r&&r.germanStart){let n=r.center().add(r.toPoint()),i=lookupUnit(r);if(i)clearUnit(board,i,n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10)),countersHighlights.clearRect(n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10),displayUnitSize+20,displayUnitSize+20),t.unshift(i),drawAvailableUnits(e,t);else{let i=t.shift();i.position={x:r.x,y:r.y},drawUnit(board,i,n.x-displayUnitSize/2,n.y-displayUnitSize/2),countersHighlights.drawImage(document.getElementById("delete_counter"),n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10),displayUnitSize+20,displayUnitSize+20),drawAvailableUnits(e,t)}}0===t.length?(document.getElementById("next_step_0").style.display="block",document.getElementById("next_step_0_button").onclick=combatAnnouncePhase):document.getElementById("next_step_0").style.display="none"}},document.addEventListener("click",handleStep0Click)}let battles=[],battle=null,battleResult="",currentBattle=null;function combatAnnouncePhase(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),currentTurn.phase="combat",currentTurn.subphase="announce",document.querySelector("#step_combat > div.menu_title > img").src="img/"+currentTurn.army+"_turn.png",document.getElementById("step_combat").style.display="block",document.getElementById("step_combat_tip").innerText="Announce all the battles of this turn by selecting each set of defending and attacking units (or skip to the movement phase).",document.getElementById("step_combat_tip").style.display="block",handleCombatAnnounceClick=function(e){const t=function(e){for(const t of battles)for(const n of t.attackingUnits)if(e.id===n.id)return!0;return!1},n=function(e){for(const t of battles)if(e.id===t.defendingUnit.id)return!0;return!1},r="german"===currentTurn.army?"soviet":"german";if("counters_highlights"===e.target.id){const i=Grid.pointToHex(e.offsetX,e.offsetY);let a=grid.get(i);if(!a)return;let o=lookupUnit(a),l=grid.neighborsOf(a);if(!(o&&o.army===r&&!n(o))){if(!(o&&o.army!==r&&battle&&!t(o)))battle=null;else if(0<battle.attackingUnits.filter(e=>e.id===o.id).length)battle.attackingUnits=battle.attackingUnits.filter(e=>e.id!==o.id),0===battle.attackingUnits.length&&(battle=null);else{let e=!1;for(let t,n=0;n<l.length;n++)if(t=lookupUnit(l[n]),t&&t.id===battle.defendingUnit.id){o.attackFrom=fromNeighborsDirections[n],e=!0;break}e?battle.attackingUnits.push(o):battle=null}refreshBattles()}else if(!battle||battle.defendingUnit.id!==o.id){battle=null;let e=[];for(let n,a=0;a<l.length;a++)n=lookupUnit(l[a]),n&&n.army!==r&&!t(n)&&(n.attackFrom=toNeighborsDirections[a],e.push(n));0<e.length&&(battle={attackingUnits:e,defendingUnit:o}),refreshBattles()}}},document.addEventListener("click",handleCombatAnnounceClick)}let validRetreat=[],singleValidRetreat=[],currentDefendingUnit=null,initialDefendingUnitPosition={x:-1,y:-1};function handleRetreatSelectionClick(e){const t=Grid.pointToHex(e.offsetX,e.offsetY);let n=grid.get(t);if(n){let e=singleValidRetreat.filter(function(e){return e.equals(n)});if(0<e.length){let t=e[0].from.slice();t.push({x:e[0].x,y:e[0].y}),moveUnit(currentDefendingUnit,t);for(const e of singleValidRetreat){for(const t of e.from)clearHex(hexHighlights,Hex(t)),0<battles.filter(function(e){return Hex(t).equals(e.defendingUnit.position)}).length&&highlightHex(hexHighlights,Hex(t));clearHex(hexHighlights,e)}clearHex(hexHighlights,Hex(currentDefendingUnit.position)),document.removeEventListener("click",handleRetreatSelectionClick),"EX"===battleResult?matchLoss():advanceAfterCombat()}}}function findRetreat(e){const t=grid.get(currentDefendingUnit.position);let n=t.center().add(t.toPoint()),i=document.querySelector(".table_battle div.battle_result");validRetreat=[];let r="soviet"===currentDefendingUnit.army?"german":"soviet",a=grid.neighborsOf(t).filter(function(e){return e&&"off"!==e.terrain&&(!lookupUnit(e)||lookupUnit(e).army!==r)});for(const n of a){let e=Hex(n);e.cost=isEZOC(e,currentDefendingUnit.army)?1:0,identifyRetreat(t,e,1)}validRetreat.sort(function(e,t){return e.cost-t.cost||e.dist-t.dist});const o="reduced"===currentDefendingUnit.strength?0:1;if(0<validRetreat.length&&validRetreat[0].cost<=o){0<validRetreat[0].cost&&(currentDefendingUnit.strength="reduced",b4mUnits[b4mUnitsIndex(currentDefendingUnit)].strength="reduced",clearUnit(board,currentDefendingUnit,n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10)),drawUnit(board,currentDefendingUnit,n.x-displayUnitSize/2,n.y-displayUnitSize/2),i.innerText+=" It loses 1 step as it must retreat through an EZOC.");let r=validRetreat.filter(function(e){return validRetreat[0].cost===e.cost&&validRetreat[0].dist===e.dist});if(singleValidRetreat=[],1<r.length){for(const e of r){let n=!1;for(const t of singleValidRetreat)if(t.x===e.x&&t.y===e.y){n=!0;break}if(!n){singleValidRetreat.push(e);let n=Hex(e).center().add(Hex(e).toPoint());hexHighlights.setLineDash([10,10]),hexHighlights.strokeStyle="rgba(0, 0, 255, 0.3)",hexHighlights.lineWidth=7,hexHighlights.beginPath();const i=t.center().add(t.toPoint());hexHighlights.moveTo(i.x,i.y);let r;for(const t of e.from)r=Hex(t).center().add(Hex(t).toPoint()),hexHighlights.lineTo(r.x,r.y);hexHighlights.lineTo(n.x,n.y),hexHighlights.stroke(),hexHighlights.beginPath(),hexHighlights.lineWidth=4,hexHighlights.setLineDash([]);const a=n.x-r.x,o=n.y-r.y,l=Math.atan2(o,a);hexHighlights.moveTo(n.x,n.y),hexHighlights.lineTo(n.x-20*Math.cos(l-Math.PI/6),n.y-20*Math.sin(l-Math.PI/6)),hexHighlights.moveTo(n.x,n.y),hexHighlights.lineTo(n.x-20*Math.cos(l+Math.PI/6),n.y-20*Math.sin(l+Math.PI/6)),hexHighlights.stroke()}}document.querySelector(".table_battle div.battle_result_action").innerText="Select a valid destination for the retreat...",document.addEventListener("click",handleRetreatSelectionClick)}else{let n=validRetreat[0].from.slice();n.push({x:validRetreat[0].x,y:validRetreat[0].y}),moveUnit(currentDefendingUnit,n),clearHex(hexHighlights,t),e()}}else i.innerText+=" But there is no valid retreat so it is eliminated.",clearUnit(board,currentDefendingUnit,n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10)),clearHex(hexHighlights,t),e()}function identifyRetreat(e,t,i){const r="soviet"===lookupUnit(e).army?"german":"soviet";let a=grid.neighborsOf(t).filter(function(t){return t&&"off"!==t.terrain&&(!lookupUnit(t)||lookupUnit(t).army!==r)&&t.distance(e)>i});for(const r of a){let n=Hex(r);n.dist=n.distance(e),n.from=[],t.from&&0<t.from.length&&(n.from=t.from.slice()),n.from.push({x:t.x,y:t.y}),n.dist===i+1&&(n.cost=isEZOC(n,lookupUnit(e).army)?t.cost+1:t.cost,2>n.cost&&(lookupUnit(n)?identifyRetreat(e,n,i+1):validRetreat.push(n)))}}function handleAdvanceAfterCombatClick(e){const t=Grid.pointToHex(e.offsetX,e.offsetY);let n=grid.get(t);if(n){let e=currentBattle.attackingUnits.filter(function(e){return Hex(e.position).equals(n)});0<e.length&&(moveUnit(e[0],[initialDefendingUnitPosition]),document.removeEventListener("click",handleAdvanceAfterCombatClick))}}function advanceAfterCombat(){document.querySelector(".table_battle div.battle_result_action").innerText="Use the option to advance into the vacated hex or continue without...",document.querySelector(".table_battle div.next_battle_button").style.display="inline-block",document.addEventListener("click",handleAdvanceAfterCombatClick)}function handleMatchLossClick(e){const t=Grid.pointToHex(e.offsetX,e.offsetY);let n=grid.get(t);if(n){let e=currentBattle.attackingUnits.filter(function(e){return Hex(e.position).equals(n)});if(0<e.length){let t=document.querySelector(".table_battle div.battle_result"),n=currentDefendingUnit.combatFull-currentDefendingUnit.combatReduced;"reduced"===currentDefendingUnit.strength&&(n=currentDefendingUnit.combatReduced);let i=Hex(e[0].position).center().add(Hex(e[0].position).toPoint());clearUnit(board,e[0],i.x-(displayUnitSize/2+10),i.y-(displayUnitSize/2+10)),"reduced"===e[0].strength||e[0].combatFull-e[0].combatReduced<n?t.innerText+=" The selected attacking unit is eliminated during the exchange.":(e[0].strength="reduced",b4mUnits[b4mUnitsIndex(e[0])].strength="reduced",drawUnit(board,e[0],i.x-displayUnitSize/2,i.y-displayUnitSize/2),t.innerText+=" The selected attacking unit loses 1 step during the exchange."),advanceAfterCombat(),document.removeEventListener("click",handleMatchLossClick)}}}function matchLoss(){let e=currentDefendingUnit.combatFull-currentDefendingUnit.combatReduced;if("reduced"===currentDefendingUnit.strength&&(e=currentDefendingUnit.combatReduced),1===currentBattle.attackingUnits.length){let t=document.querySelector(".table_battle div.battle_result"),n=Hex(currentBattle.attackingUnits[0].position).center().add(Hex(currentBattle.attackingUnits[0].position).toPoint());clearUnit(board,currentBattle.attackingUnits[0],n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10)),"reduced"===currentBattle.attackingUnits[0].strength||currentBattle.attackingUnits[0].combatFull-currentBattle.attackingUnits[0].combatReduced<e?(t.innerText+=" The attacking unit is eliminated during the exchange.",document.querySelector(".table_battle div.next_battle_button").style.display="inline-block"):(currentBattle.attackingUnits[0].strength="reduced",b4mUnits[b4mUnitsIndex(currentBattle.attackingUnits[0])].strength="reduced",drawUnit(board,currentBattle.attackingUnits[0],n.x-displayUnitSize/2,n.y-displayUnitSize/2),t.innerText+=" The attacking unit loses 1 step during the exchange.",advanceAfterCombat())}else document.querySelector(".table_battle div.battle_result_action").innerText="Select the attacking unit to match the defending unit's loss (at least "+e+" strength points)...",document.addEventListener("click",handleMatchLossClick)}function handleAttackingUnitLossClick(e){const t=Grid.pointToHex(e.offsetX,e.offsetY);let n=grid.get(t);if(n){let e=currentBattle.attackingUnits.filter(function(e){return Hex(e.position).equals(n)});if(0<e.length){let t=document.querySelector(".table_battle div.battle_result"),n=Hex(e[0].position).center().add(Hex(e[0].position).toPoint());clearUnit(board,e[0],n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10)),"reduced"===e[0].strength?t.innerText+=" The attacking unit strength is already reduced so it is eliminated.":(e[0].strength="reduced",b4mUnits[b4mUnitsIndex(e[0])].strength="reduced",drawUnit(board,e[0],n.x-displayUnitSize/2,n.y-displayUnitSize/2)),document.querySelector(".table_battle div.next_battle_button").style.display="inline-block",document.removeEventListener("click",handleAttackingUnitLossClick)}}}function resolveNextBattle(){document.removeEventListener("click",handleAdvanceAfterCombatClick),document.removeEventListener("click",handleAttackingUnitLossClick),document.removeEventListener("click",handleMatchLossClick),document.removeEventListener("click",handleRetreatSelectionClick),refreshBattles(),document.getElementById("step_combat").style.display="block",document.getElementById("next_step_resolve_battles").style.display="none";const e=document.querySelectorAll(".table_battle > tr i");for(let t of e)t.parentNode.removeChild(t);const t=document.querySelectorAll(".table_battle > tr");if(0<t.length){currentBattle=battles.shift();t[0].style.backgroundColor="rgba(0, 0, 255, 0.25)";for(const e of currentBattle.attackingUnits)highlightHex(hexHighlights,grid.get(e.position),"rgba(0, 0, 255, 0.25)");currentDefendingUnit=currentBattle.defendingUnit,initialDefendingUnitPosition.x=currentDefendingUnit.position.x,initialDefendingUnitPosition.y=currentDefendingUnit.position.y;const e=grid.get(currentDefendingUnit.position);highlightHex(hexHighlights,e,"rgba(0, 0, 255, 0.25)");let n=e.center().add(e.toPoint());window.scrollTo(e.toPoint().x-window.innerWidth/2,e.toPoint().y-window.innerHeight/2);const i=Math.floor(6*Math.random())+1;let r=document.createElement("tr");r.innerHTML="<td colspan=\"5\" style=\"padding-bottom: 20px;\"><img class=\"die_roll\" src=\"img/"+i+".png\" /><table class=\"table_battle_odds\"><tr><td>1:1</td><td>2:1</td><td>3:1</td><td>4:1</td><td>5:1</td><td>6:1</td></tr><tr><td>DR</td><td>DR</td><td>DR</td><td>DR</td><td>DR</td><td>DRL</td></tr><tr><td>EX</td><td>DR</td><td>DR</td><td>DR</td><td>DRL</td><td>DRL</td></tr><tr><td>EX</td><td>EX</td><td>DR</td><td>EX</td><td>DRL</td><td>DE</td></tr><tr><td>NE</td><td>EX</td><td>EX</td><td>DRL</td><td>DRL</td><td>DE</td></tr><tr><td>NE</td><td>NE</td><td>EX</td><td>DRL</td><td>DE</td><td>DE</td></tr><tr><td>AL</td><td>NE</td><td>DRL</td><td>DE</td><td>DE</td><td>DE</td></tr></table><div class=\"battle_result\"></div><div class=\"battle_result_action\"></div><div class=\"next_battle_button\" style=\"display:none;\" onclick=\"resolveNextBattle();\">Next <i class=\"fa fa-arrow-circle-o-right\" aria-hidden=\"true\"></i></div></td>",1<t.length?document.querySelector(".table_battle").insertBefore(r,t[1]):document.querySelector(".table_battle").appendChild(r);let a=document.querySelectorAll(".table_battle_odds td:nth-child("+currentBattle.battleOdds+")");const o="solid thin lightgray";for(let e of a)e.style.borderLeft=o,e.style.borderRight=o;document.querySelector(".table_battle_odds tr:nth-child(1) td:nth-child("+currentBattle.battleOdds+")").style.borderTop="solid thin lightgray",document.querySelector(".table_battle_odds tr:last-child td:nth-child("+currentBattle.battleOdds+")").style.borderBottom="solid thin lightgray",document.querySelector(".table_battle_odds tr:nth-child("+(i+1)+")").style.border="solid thin lightgray",document.querySelector(".table_battle_odds tr:nth-child("+(i+1)+") td:nth-child("+currentBattle.battleOdds+")").style.fontWeight="bold";let l=e.toPoint(),s=document.createElement("div");s.setAttribute("class","explosion"),s.style.display="block",s.style.top=l.y-10+"px",s.style.left=l.x-10+"px",document.body.appendChild(s),battleResult=document.querySelector(".table_battle_odds tr:nth-child("+(i+1)+") td:nth-child("+currentBattle.battleOdds+")").innerText;let d=document.querySelector(".table_battle div.battle_result");switch(battleResult){case"NE":d.innerText="The battle has no effect.",document.querySelector(".table_battle div.next_battle_button").style.display="inline-block";break;case"DR":d.innerText="The defending unit needs to retreat 2 hexes.",e.city&&("moscow"===e.city||"major"===e.city)&&"full"===currentDefendingUnit.strength?(currentDefendingUnit.strength="reduced",b4mUnits[b4mUnitsIndex(currentDefendingUnit)].strength="reduced",clearUnit(board,currentDefendingUnit,n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10)),drawUnit(board,currentDefendingUnit,n.x-displayUnitSize/2,n.y-displayUnitSize/2),d.innerText+=" But it is in a major city, so it takes a step loss instead and doesn't retreat.",document.querySelector(".table_battle div.next_battle_button").style.display="inline-block"):findRetreat(advanceAfterCombat);break;case"DRL":d.innerText="The defending unit loses 1 step and is retreated 2 hexes.","reduced"===currentDefendingUnit.strength?(d.innerText+=" But its strength is already reduced so it is eliminated.",clearUnit(board,currentDefendingUnit,n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10)),clearHex(hexHighlights,e),advanceAfterCombat()):(currentDefendingUnit.strength="reduced",b4mUnits[b4mUnitsIndex(currentDefendingUnit)].strength="reduced",clearUnit(board,currentDefendingUnit,n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10)),drawUnit(board,currentDefendingUnit,n.x-displayUnitSize/2,n.y-displayUnitSize/2),findRetreat(advanceAfterCombat));break;case"DE":d.innerText="The defending unit is eliminated.",clearUnit(board,currentDefendingUnit,n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10)),clearHex(hexHighlights,e),advanceAfterCombat();break;case"EX":d.innerText="Exchange!","reduced"===currentDefendingUnit.strength?(d.innerText+=" The defending unit strength is already reduced so it is eliminated.",clearUnit(board,currentDefendingUnit,n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10)),clearHex(hexHighlights,e),matchLoss()):(currentDefendingUnit.strength="reduced",b4mUnits[b4mUnitsIndex(currentDefendingUnit)].strength="reduced",clearUnit(board,currentDefendingUnit,n.x-(displayUnitSize/2+10),n.y-(displayUnitSize/2+10)),drawUnit(board,currentDefendingUnit,n.x-displayUnitSize/2,n.y-displayUnitSize/2),findRetreat(matchLoss));break;case"AL":if(d.innerText="One attacking unit needs to lose 1 step.",1===currentBattle.attackingUnits.length){let e=Hex(currentBattle.attackingUnits[0].position).center().add(Hex(currentBattle.attackingUnits[0].position).toPoint());clearUnit(board,currentBattle.attackingUnits[0],e.x-(displayUnitSize/2+10),e.y-(displayUnitSize/2+10)),"reduced"===currentBattle.attackingUnits[0].strength?d.innerText+=" The attacking unit strength is already reduced so it is eliminated.":(currentBattle.attackingUnits[0].strength="reduced",b4mUnits[b4mUnitsIndex(currentBattle.attackingUnits[0])].strength="reduced",drawUnit(board,currentBattle.attackingUnits[0],e.x-displayUnitSize/2,e.y-displayUnitSize/2)),document.querySelector(".table_battle div.next_battle_button").style.display="inline-block"}else document.querySelector(".table_battle div.battle_result_action").innerText="Select the attacking unit to be impacted...",document.addEventListener("click",handleAttackingUnitLossClick);break;default:console.log("ERROR - Invalid battle result: "+battleResult);}}else{document.getElementById("step_combat_tip").innerText="All battles have been resolved.";for(const t of document.querySelectorAll("div.explosion"))document.body.removeChild(t)}}function combatResolvePhase(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),currentTurn.phase="combat",currentTurn.subphase="resolve",battle=null,resolveNextBattle()}function getValidNormalDestinations(e,t,n){let i=Hex(e);const r="german"===t?"soviet":"german";i.credit=3===currentTurn.turn||4===currentTurn.turn?1:n,i.path=[];let a=[i],o=[i],l=[],s=0;for(;0<a.length;){let e=a.shift();s++,1<s&&l.push(e);for(const n of grid.neighborsOf(e)){let i=Hex(n);if(i&&"off"!==i.terrain){i.credit=e.credit-1,"forest"===i.terrain&&0<i.credit&&i.credit--;let n=lookupUnit(i);n&&n.army===r&&(i.credit=-1),isEZOC(i,t)&&-1<i.credit&&(i.credit=0);let l=indexOfHex(i,o);0>l?-1<i.credit&&(o.push(i),i.path=e.path.slice(),i.path.push({x:e.x,y:e.y}),a.push(i)):i.credit>o[l].credit&&(o[l].credit=i.credit,i.path=e.path.slice(),i.path.push({x:e.x,y:e.y}),a.push(i))}}}return l}let hexSelected=null,available=[],hasMoved=[];function handleMovement(e,t){const n=Grid.pointToHex(e.offsetX,e.offsetY);let r=Hex(grid.get(n)),i=lookupUnit(r);if(!hexSelected){let e=!1;for(const t of hasMoved)r&&i&&t.id===i.id&&(e=!0);if(!r||!i||i.army!==currentTurn.army||e)return hexSelected=null,available=[],void hexHighlights.clearRect(0,0,canvasHexHighlights.width,canvasHexHighlights.height);hexSelected=Hex(r);const n=i.movement;let a=t(r,currentTurn.army,n);for(let e,t=0;t<a.length;t++)e=lookupUnit(grid.get(a[t])),e&&e.army===currentTurn.army||(available.push(a[t]),highlightHex(hexHighlights,a[t],"rgba(255, 255, 255, 0.35)"))}else{let e=null;for(let t=0;t<available.length;t++)if(r.equals(available[t])){e=Hex(available[t]);break}if(e){let t=e.path.slice(1);t.push({x:e.x,y:e.y});let n=lookupUnit(hexSelected);moveUnit(n,t,!0),hasMoved.push(n)}hexSelected=null,available=[],hexHighlights.clearRect(0,0,canvasHexHighlights.width,canvasHexHighlights.height)}}function movementPhase(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),currentTurn.phase="movement",currentTurn.subphase="",document.querySelector("#step_movement > div.menu_title > img").src="img/"+currentTurn.army+"_turn.png",document.getElementById("step_movement").style.display="block",7===currentTurn.turn&&"soviet"===currentTurn.army?(document.getElementById("next_step_movement").style.display="none",setTimeout(function(){document.getElementById("next_step_final").style.display="block",document.getElementById("next_step_final").onclick=finalResults},2000)):setTimeout(function(){document.getElementById("next_step_movement").onclick=4===currentTurn.turn&&"german"===currentTurn.army?reinforcementPhase:replacementPhase},3000),hexSelected=null,available=[],hasMoved=[],handleMovementClick=function(e){handleMovement(e,getValidNormalDestinations)},document.addEventListener("click",handleMovementClick)}let followingReinforcement=!1;function reinforcementPhase(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),currentTurn.army="soviet",currentTurn.phase="replacement",currentTurn.subphase="reinforcement",document.getElementById("step_replacement_count").innerHTML="",document.getElementById("next_step_replacement").style.display="none",document.getElementById("step_replacement").style.display="block",document.querySelector("#step_replacement > div.menu_title > img").src="img/"+currentTurn.army+"_turn.png",document.getElementById("step_replacement_tip").innerText="Place the reinforcement unit in the eligible area of the map.";let t=b4mGrid.filter(function(t){let e=grid.get({x:t.x,y:t.y}),n=!1;return!e.sovietReplacement||lookupUnit(e)||isEZOC(e,"soviet")||(highlightHex(hexHighlights,e),n=!0),n}),n=document.getElementById("canvas_step_reinforcement");n.style.display="block";let i=b4mUnits.filter(function(e){return"soviet"===e.army&&"shock"===e.type});drawAvailableUnits(n,i),handleReinforcementClick=function(e){if("counters_highlights"===e.target.id){const r=Grid.pointToHex(e.offsetX,e.offsetY);let a=grid.get(r),o=-1;for(let e=0;e<t.length;e++)if(Hex(t[e]).equals(a)){o=e;break}if(-1<o){let e=a.center().add(a.toPoint()),t=lookupUnit(a);if(t)clearUnit(board,t,e.x-(displayUnitSize/2+10),e.y-(displayUnitSize/2+10)),countersHighlights.clearRect(e.x-(displayUnitSize/2+10),e.y-(displayUnitSize/2+10),displayUnitSize+20,displayUnitSize+20),i.unshift(t),drawAvailableUnits(n,i);else{let t=i.shift();t.position={x:a.x,y:a.y},drawUnit(board,t,e.x-displayUnitSize/2,e.y-displayUnitSize/2),countersHighlights.drawImage(document.getElementById("delete_counter"),e.x-(displayUnitSize/2+10),e.y-(displayUnitSize/2+10),displayUnitSize+20,displayUnitSize+20),drawAvailableUnits(n,i)}}0===i.length?(followingReinforcement=!0,document.getElementById("next_step_reinforcement").style.display="block",document.getElementById("next_step_reinforcement").onclick=replacementPhase):document.getElementById("next_step_reinforcement").style.display="none"}},document.addEventListener("click",handleReinforcementClick)}function replacementPhase(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),"german"===currentTurn.army?currentTurn.army="soviet":(!followingReinforcement&&(currentTurn.turn++,setTurnInfo(),currentTurn.army="german"),followingReinforcement=!1),currentTurn.phase="replacement",currentTurn.subphase="standard",document.getElementById("step_replacement").style.display="block",document.getElementById("next_step_reinforcement").style.display="none",document.querySelector("#step_replacement > div.menu_title > img").src="img/"+currentTurn.army+"_turn.png",document.getElementById("step_replacement_tip").innerText="Place new half-strength units in the eligible area of the map or flip a half-strength unit that is currently on the map over to its full-strength side.",setTimeout(function(){document.getElementById("next_step_replacement").style.display="block",document.getElementById("next_step_replacement").onclick=specialMovementPhase},2000);let t=0;t="soviet"===currentTurn.army?3===currentTurn.turn||4===currentTurn.turn?4:5:1;const n=function(){document.getElementById("step_replacement_count").innerHTML=0<t?"You have <strong>"+t+"</strong> replacement step"+(1<t?"s":"")+" left to assign.":"You have finished assigning your replacements."};n();const i=function(e,t){let n=Hex(grid.get(e));const i="soviet"===t?n.sovietReplacement:n.germanReplacement;if(i)return!0;const r="soviet"===t?10*(13-n.x):10*n.x,a="german"===t?"soviet":"german";n.credit=r,n.path=[];let o=[n],l=[n],s=0;for(;0<o.length;){let e=o.shift();s++;const n="soviet"===t?e.sovietReplacement:e.germanReplacement,i=lookupUnit(e);if(1<s&&n&&(!i||i.army===t)&&!isEZOC(e,t))return!0;for(const n of grid.neighborsOf(e)){let i=Hex(n);if(i&&"off"!==i.terrain){i.credit=e.credit-1;let n=lookupUnit(i);n&&n.army===a&&(i.credit=-1),isEZOC(i,t)&&-1<i.credit&&(i.credit=0);let r=indexOfHex(i,l);0>r?-1<i.credit&&(l.push(i),i.path=e.path.slice(),i.path.push({x:e.x,y:e.y}),o.push(i)):i.credit>l[r].credit&&(l[r].credit=i.credit,i.path=e.path.slice(),i.path.push({x:e.x,y:e.y}),o.push(i))}}}return!1},r=function(){let e=b4mUnits.filter(function(e){return e.army===currentTurn.army&&"shock"!==e.type&&!e.position}).sort(function(e,t){return"infantry"===e.type&&"tank"===t.type?1:"tank"===e.type&&"infantry"===t.type?-1:t.combatFull-e.combatFull});return 0===e.length?null:(e[0].strength="reduced",e[0])};let a=[];r()&&(a=b4mGrid.filter(function(t){let e=grid.get({x:t.x,y:t.y}),n=!1;const r="soviet"===currentTurn.army?e.sovietReplacement:e.germanReplacement;return!r||lookupUnit(e)||isEZOC(e,currentTurn.army)?e.city&&"none"!==e.city&&e.control===currentTurn.army&&!lookupUnit(e)&&!isEZOC(e,currentTurn.army)&&("soviet"===currentTurn.army&&"moscow"===e.city?(highlightHex(hexHighlights,e),n=!0):i(e,currentTurn.army)&&(highlightHex(hexHighlights,e),n=!0)):(highlightHex(hexHighlights,e),n=!0),n}));let o=b4mUnits.filter(function(e){return!!(e.army===currentTurn.army&&"reduced"===e.strength&&e.position&&i(Hex(e.position),currentTurn.army))&&(highlightHex(hexHighlights,Hex(e.position)),!0)});handleReplacementClick=function(e){const i=Grid.pointToHex(e.offsetX,e.offsetY),l=Hex(grid.get(i)),s=lookupUnit(l);if(l&&0<t){let e=-1;for(let t=0;t<a.length;t++)if(Hex(a[t]).equals(l)){e=t;break}if(-1<e){let i=r();if(i){clearHex(hexHighlights,l);let r=l.center().add(l.toPoint());i.position={x:l.x,y:l.y},drawUnit(board,i,r.x-displayUnitSize/2,r.y-displayUnitSize/2),countersHighlights.drawImage(document.getElementById("check_counter"),r.x-(displayUnitSize/2+10),r.y-(displayUnitSize/2+10),displayUnitSize+20,displayUnitSize+20),a.splice(e,1),t--,n()}}else if(s&&s.army===currentTurn.army){let e=-1;for(let t=0;t<o.length;t++)if(Hex(o[t].position).equals(l)){e=t;break}if(-1<e){o[e].strength="full",clearHex(hexHighlights,l);let i=l.center().add(l.toPoint());drawUnit(board,o[e],i.x-displayUnitSize/2,i.y-displayUnitSize/2),countersHighlights.drawImage(document.getElementById("check_counter"),i.x-(displayUnitSize/2+10),i.y-(displayUnitSize/2+10),displayUnitSize+20,displayUnitSize+20),o.splice(e,1),t--,n()}}}},document.addEventListener("click",handleReplacementClick)}function getValidRailDestinations(e,t,n){let i=Hex(e),r=[];if(i.rail&&0<i.rail.length){const e="german"===t?"soviet":"german";i.credit=n,i.path=[];let a=[i],o=[i],l=0;for(;0<a.length;){let n=a.shift();l++,1<l&&r.push(n);let i=grid.neighborsOf(n),s=[];for(const e of n.rail)s.push(i[toNeighborsDirections.indexOf(e)]);for(const i of s){let r=Hex(i);if(r&&"off"!==r.terrain){r.credit=n.credit-1;let i=lookupUnit(r);i&&i.army===e&&(r.credit=-1),isEZOC(r,t)&&-1<r.credit&&(r.credit=0);let l=indexOfHex(r,o);0>l?-1<r.credit&&(o.push(r),r.path=n.path.slice(),r.path.push({x:n.x,y:n.y}),a.push(r)):r.credit>o[l].credit&&(o[l].credit=r.credit,r.path=n.path.slice(),r.path.push({x:n.x,y:n.y}),a.push(r))}}}}return r}function getValidPanzerDestinations(e,t,n){const i=lookupUnit(e);return i&&"german"===i.army&&"tank"===i.type?getValidNormalDestinations(e,t,n):[]}function specialMovementPhase(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),currentTurn.phase="special movement",currentTurn.subphase="",document.getElementById("step_special_movement").style.display="block",document.querySelector("#step_special_movement > div.menu_title > img").src="img/"+currentTurn.army+"_turn.png",document.getElementById("step_special_movement_tip").innerText="soviet"===currentTurn.army?"All units that begin this phase on a rail line may move along it.":"All armor/panzer units may move.",setTimeout(function(){document.getElementById("next_step_special_movement").style.display="block",document.getElementById("next_step_special_movement").onclick=combatAnnouncePhase},2000),hexSelected=null,available=[],hasMoved=[],handleSpecialMovementClick=function(e){"soviet"===currentTurn.army?handleMovement(e,getValidRailDestinations):handleMovement(e,getValidPanzerDestinations)},document.addEventListener("click",handleSpecialMovementClick)}function finalResults(e){e&&e.stopPropagation(),cleanBeforeNewPhase(),currentTurn.phase="game over",currentTurn.subphase="",document.getElementById("final_results").style.display="block",console.log("GAME OVER");let t="",n="",i="";for(const t of b4mGrid)if(t.city&&"moscow"===t.city){i=grid.get(t).control;break}if("german"===i)t="<img src=\"img/german_marker.png\" /><span>The German Army won!</span>",n="The German Army wins because it controls Moscow at the end of Game Turn 7.";else{let e=b4mGrid.filter(function(e){const t=grid.get(e);return t.city&&"moscow"!==t.city&&"soviet"===t.control});0<e.length?(t="<img src=\"img/soviet_marker.png\" /><span>The Red Army won!</span>",n="The Red Army wins because it controls Moscow and one other city at the end of Game Turn 7."):(t="<span>It is a draw!</span>",n="The Red Army still controls Moscow but the German Army controls all the other cities at the end of Game Turn 7.")}document.querySelector("#final_results > div.menu_title").innerHTML=t,document.getElementById("final_results_tip").innerText=n}class Game{constructor(){canvasBoard=document.getElementById("board"),canvasBoard.width=document.getElementById("map").width,canvasBoard.height=document.getElementById("map").height,board=canvasBoard.getContext("2d"),canvasHexHighlights=document.getElementById("hex_highlights"),canvasHexHighlights.width=document.getElementById("map").width,canvasHexHighlights.height=document.getElementById("map").height,hexHighlights=canvasHexHighlights.getContext("2d"),canvasCountersHighlights=document.getElementById("counters_highlights"),canvasCountersHighlights.width=document.getElementById("map").width,canvasCountersHighlights.height=document.getElementById("map").height,countersHighlights=canvasCountersHighlights.getContext("2d"),arrows=document.getElementById("arrows_counter"),drawPositionedUnits(),turn1GermanSetupPhase(board,hexHighlights,countersHighlights)}}function indexOfHex(e,t){for(let n=0;n<t.length;n++)if(e.equals(t[n]))return n;return-1}window.addEventListener("load",function(){new Game});